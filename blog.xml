<?xml version="1.0" encoding="UTF-8"?>
<rss  xmlns:atom="http://www.w3.org/2005/Atom" 
      xmlns:media="http://search.yahoo.com/mrss/" 
      xmlns:content="http://purl.org/rss/1.0/modules/content/" 
      xmlns:dc="http://purl.org/dc/elements/1.1/" 
      version="2.0">
<channel>
<title>OBi</title>
<link>https://olebialas.github.io/blog.html</link>
<atom:link href="https://olebialas.github.io/blog.xml" rel="self" type="application/rss+xml"/>
<description>A neuroscience and coding blog and portfolio by Ole Bialas</description>
<language>en-gb</language>
<image>
<url>https://olebialas.github.io/assets/images/profile.png</url>
<title>OBi</title>
<link>https://olebialas.github.io/blog.html</link>
</image>
<generator>quarto-1.8.25</generator>
<lastBuildDate>Thu, 09 Oct 2025 22:00:00 GMT</lastBuildDate>
<item>
  <title>Tracking Units in Chronic Electrophysiological Recordings with UnitMatch</title>
  <dc:creator>Ole Bialas</dc:creator>
  <link>https://olebialas.github.io/posts/2024-10-02-unitmatch/</link>
  <description><![CDATA[ 






<p>I recently consulted on a project where chronic recordings from mice were made with implanted electrodes. This presents challenges: processing multi-day recordings in one go is highly inefficient or impossible due to memory limitations. While dividing data into chunks enables parallel processing, it creates a new problem: the units identified in different recording segments do not follow the same order (e.g.&nbsp;unit 1 in recording 1 is likely not the same as unit 1 in recording 2). Thus, the units must somehow be matched across recordings based on physiological features.</p>
<p>While searching for solutions to this problem, I came across UnitMatch - an algorithm that uses a naive Bayes classifier to match units based on their average spike waveforms (more on that later). The algorithm was published in <a href="https://www.nature.com/articles/s41592-024-02440-1">Nature Methods</a> and there is a <a href="https://github.com/EnnyvanBeest/UnitMatch?tab=readme-ov-file">Matlab and a Python toolbox</a> available. Unfortunately, I found that the project lacks documentation and existing tutorial notebooks contained errors or were incomplete (due to missing data).</p>
<p>To test and verify the functionalities of UnitMatch, I created this notebook where I simulate multiple electrophysiological recordings with SpikeInterface and identify matching units across recordings. I hope prospective UnitMatch users will find it useful. Feel free to play around with the parameters of the simulation and UnitMatch to see how it affects the results. To follow along with the examples, you’ll have to install the following packages (I recommend using a new virtual environment).</p>
<pre><code>pip install numpy matplotlib spikeinterface UnitMatchPy</code></pre>
<div id="5101a69c" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> pathlib <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Path</span>
<span id="cb2-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb2-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> matplotlib <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb2-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> spikeinterface.core <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> si</span>
<span id="cb2-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> spikeinterface.preprocessing <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> spre</span>
<span id="cb2-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> spikeinterface.core.generate <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> (</span>
<span id="cb2-7">    generate_unit_locations,</span>
<span id="cb2-8">    generate_templates,</span>
<span id="cb2-9">    generate_ground_truth_recording,</span>
<span id="cb2-10">    default_unit_params_range,</span>
<span id="cb2-11">)</span>
<span id="cb2-12"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> spikeinterface.curation <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> MergeUnitsSorting</span>
<span id="cb2-13"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> spikeinterface <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> aggregate_units</span>
<span id="cb2-14"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> probeinterface <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> generate_multi_columns_probe</span>
<span id="cb2-15"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> probeinterface.plotting <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> plot_probe</span>
<span id="cb2-16"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> UnitMatchPy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> um</span>
<span id="cb2-17"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> UnitMatchPy.default_params <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> default_params</span></code></pre></div></div>
</div>
<section id="simulating-data-with-spikeinterface" class="level1">
<h1>Simulating Data with SpikeInterface</h1>
<p>This section simulates multiple electrophysiological recordings and their corresponding spike sorting results. The basic idea is that we generate a template waveform for each unit and then simulate the recordings from these template waveforms. The waveform parameters will be slightly varied across recordings to simulate the variability expected in chronic recordings (e.g.&nbsp;due to movement of the electrodes). First, we need to define the parameters for the simulated data.</p>
<div id="683ec373" class="cell" data-execution_count="2">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1">seed <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># set seed for reproducibility</span></span>
<span id="cb3-2">n_recordings <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># number of recordings</span></span>
<span id="cb3-3">n_units <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># number of units</span></span>
<span id="cb3-4">n_columns <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># number of electrode columns</span></span>
<span id="cb3-5">n_contacts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># number of channels per column</span></span></code></pre></div></div>
</div>
<p>To simulate recordings, we generate a probe and unit locations along it. The probe and unit locations will be the same for all recording segments.</p>
<div id="cell-fig-probe" class="cell" data-execution_count="3">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1">probe <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> generate_multi_columns_probe(</span>
<span id="cb4-2">    num_columns<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>n_columns, num_contact_per_column<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>n_contacts</span>
<span id="cb4-3">)</span>
<span id="cb4-4">probe.set_device_channel_indices(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(probe.get_contact_count()))</span>
<span id="cb4-5">channel_locations <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> probe.contact_positions</span>
<span id="cb4-6">unit_locations <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> generate_unit_locations(</span>
<span id="cb4-7">    num_units<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>n_units, channel_locations<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>channel_locations, seed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>seed</span>
<span id="cb4-8">)</span>
<span id="cb4-9">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots()</span>
<span id="cb4-10">plot_probe(probe, ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ax)</span>
<span id="cb4-11">ax.scatter(unit_locations[:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], unit_locations[:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Units"</span>)</span>
<span id="cb4-12">ax.legend()</span></code></pre></div></div>
<div class="cell-output cell-output-display">
<div id="fig-probe" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-probe-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/fig-probe-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1" title="Figure&nbsp;1: Shank of the probe with recording channels (yellow) and locations of the simulated units (blue)."><img src="https://olebialas.github.io/posts/2024-10-02-unitmatch/index_files/figure-html/fig-probe-output-1.png" width="268" height="458" class="figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-probe-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Shank of the probe with recording channels (yellow) and locations of the simulated units (blue).
</figcaption>
</figure>
</div>
</div>
</div>
<p>Next, we generate a dictionary that contains the parameters for the template waveform of every unit. SpikeInterface provides the dictionary <code>default_unit_params_range</code> that contains the default range of parameter values for simulating units (e.g.&nbsp;amplitude or spatial decay). For each unit, we’ll sample a value from that range. The result is the dictionary <code>unit_params</code> that stores arrays where each element is the parameter for one unit.</p>
<div id="30a0cb97" class="cell" data-execution_count="4">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1">rng <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.random.default_rng(seed)</span>
<span id="cb5-2">unit_params <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {}</span>
<span id="cb5-3"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> key, (low, high) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> default_unit_params_range.items():</span>
<span id="cb5-4">    unit_params[key] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rng.uniform(low, high, size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>n_units)</span>
<span id="cb5-5">unit_params</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="4">
<pre><code>{'alpha': array([433.9926522 , 338.62161079, 215.54529668, 117.18062828,
        489.46175804, 338.58868163, 416.10526577, 464.13575252,
        375.26177904, 175.99658936]),
 'depolarization_ms': array([0.13907395, 0.104237  , 0.12146366, 0.11905182, 0.11999561,
        0.11676241, 0.13978886, 0.1150973 , 0.12855113, 0.11470809]),
 'repolarization_ms': array([0.79930235, 0.79358658, 0.61807041, 0.59657758, 0.7586542 ,
        0.73979747, 0.70742919, 0.62255536, 0.61692954, 0.53949452]),
 'recovery_ms': array([1.31274874, 1.04120069, 1.13728649, 1.32805851, 1.00733802,
        1.41726609, 1.03619954, 1.26206041, 1.27327526, 1.11362348]),
 'positive_amplitude': array([0.24339673, 0.15114458, 0.17570612, 0.23010754, 0.19854294,
        0.15770836, 0.11444086, 0.24337084, 0.18843507, 0.18732443]),
 'smooth_ms': array([0.05388581, 0.03595496, 0.05240195, 0.0525267 , 0.05323953,
        0.03739796, 0.05838476, 0.03280083, 0.0429946 , 0.03427422]),
 'spatial_decay': array([34.96057387, 30.03148015, 29.32616207, 21.47386745, 28.84192769,
        24.47022155, 26.05951453, 27.88696017, 34.13261297, 35.72726278]),
 'propagation_speed': array([285.68360953, 317.01298515, 301.022312  , 317.11452607,
        283.03320714, 339.84195609, 316.27920104, 269.17973465,
        307.51585252, 324.94028809]),
 'b': array([0.8019328 , 0.49395841, 0.35048142, 0.65442167, 0.75691121,
        0.55651163, 0.26614706, 0.65286473, 0.78431686, 0.92351301]),
 'c': array([0.99500395, 0.43145132, 0.8250356 , 0.72058249, 0.97564282,
        0.55789109, 0.87457736, 0.5536417 , 0.35942747, 0.96434435]),
 'x_angle': array([8.92445114e-01, 9.75961624e-01, 1.87809180e-01, 1.43342828e-03,
        1.07303982e+00, 8.50411327e-01, 2.28247368e+00, 4.60233512e-02,
        2.80095771e+00, 2.56516667e+00]),
 'y_angle': array([2.85774694, 2.41109034, 2.06560572, 2.39953077, 2.76379207,
        2.68240018, 0.8497379 , 2.99180754, 3.11848977, 2.17921963]),
 'z_angle': array([1.92613828, 1.92716042, 2.1546994 , 2.84738271, 0.97173317,
        1.25863705, 0.99223389, 2.26800388, 0.10700536, 1.26789758])}</code></pre>
</div>
</div>
<p>For each recording, we’ll add a bit of random noise to these parameters to simulate the variability that is expected across recordings (feel free to play around with the <code>variability</code> parameter to see how it affects the matching results). The <code>varied_params</code> are passed to the <code>generate_templates</code> function and the generated waveforms are stored in a list of <code>templates</code>.</p>
<div id="49e52ae2" class="cell" data-execution_count="5">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1">variability <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.02</span></span>
<span id="cb7-2">templates <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb7-3"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(n_recordings):</span>
<span id="cb7-4">    varied_params <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {}</span>
<span id="cb7-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> key <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> unit_params.keys():  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># vary unit parameters</span></span>
<span id="cb7-6">        variation <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rng.normal(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, variability <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> unit_params[key])</span>
<span id="cb7-7">        varied_params[key] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> unit_params[key] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> variation</span>
<span id="cb7-8"></span>
<span id="cb7-9">    templates.append(</span>
<span id="cb7-10">        generate_templates(</span>
<span id="cb7-11">            channel_locations<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>channel_locations,</span>
<span id="cb7-12">            units_locations<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>unit_locations,</span>
<span id="cb7-13">            sampling_frequency<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">25000</span>,</span>
<span id="cb7-14">            unit_params<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>varied_params,</span>
<span id="cb7-15">            ms_before<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>,</span>
<span id="cb7-16">            ms_after<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.0</span>,</span>
<span id="cb7-17">            seed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>seed,</span>
<span id="cb7-18">        )</span>
<span id="cb7-19">    )</span></code></pre></div></div>
</div>
<p>Let’s plot the same unit across multiple recordings. Despite slight variability, the waveforms are similar enough to enable clear matching.</p>
<div id="cell-fig-waveforms" class="cell" data-execution_count="6">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>), sharex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, sharey<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb8-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>):</span>
<span id="cb8-3">    ax[i].plot(templates[i][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, :, :])</span>
<span id="cb8-4">    ax[i].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Recording </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb8-5">ax[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(ylabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r"Voltage </span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">[$</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">\m</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">u$V]</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb8-6">ax[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(xlabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Time [samples]"</span>)</span></code></pre></div></div>
<div class="cell-output cell-output-display">
<div id="fig-waveforms" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-waveforms-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/fig-waveforms-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2" title="Figure&nbsp;2: Template waveforms for one unit across all recordings. Each line shows the signal measured at one electrode channel."><img src="https://olebialas.github.io/posts/2024-10-02-unitmatch/index_files/figure-html/fig-waveforms-output-1.png" width="761" height="302" class="figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-waveforms-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Template waveforms for one unit across all recordings. Each line shows the signal measured at one electrode channel.
</figcaption>
</figure>
</div>
</div>
</div>
<p>Finally, we use the <code>generate_ground_truth_recording</code> function to generate a list of <code>recordings</code> and <code>sortings</code> from the previously created <code>templates</code>.</p>
<div id="c547307c" class="cell" data-execution_count="7">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1">recordings, sortings <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [], []</span>
<span id="cb9-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, template <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(templates):</span>
<span id="cb9-3">    recording, sorting <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> generate_ground_truth_recording(</span>
<span id="cb9-4">        num_units<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>n_units, probe<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>probe, templates<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>template, seed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>seed</span>
<span id="cb9-5">    )</span>
<span id="cb9-6">    recordings.append(recording)</span>
<span id="cb9-7">    sortings.append(sorting)</span>
<span id="cb9-8">recordings, sortings</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre><code>([GroundTruthRecording (InjectTemplatesRecording): 12 channels - 25.0kHz - 1 segments 
                        250,000 samples - 10.00s - float32 dtype - 11.44 MiB,
  GroundTruthRecording (InjectTemplatesRecording): 12 channels - 25.0kHz - 1 segments 
                        250,000 samples - 10.00s - float32 dtype - 11.44 MiB,
  GroundTruthRecording (InjectTemplatesRecording): 12 channels - 25.0kHz - 1 segments 
                        250,000 samples - 10.00s - float32 dtype - 11.44 MiB],
 [GroundTruthSorting (NumpySorting): 10 units - 1 segments - 25.0kHz,
  GroundTruthSorting (NumpySorting): 10 units - 1 segments - 25.0kHz,
  GroundTruthSorting (NumpySorting): 10 units - 1 segments - 25.0kHz])</code></pre>
</div>
</div>
<section id="preprocessing-and-curation" class="level2">
<h2 class="anchored" data-anchor-id="preprocessing-and-curation">Preprocessing and Curation</h2>
<p>Since UnitMatch uses average unit waveforms, we must ensure they’re clearly visible across multiple recording sites. To achieve this, we’ll preprocess the recordings and select units based on quality criteria. For the simulated data, I am only applying a bandpass filter, but real data may require additional steps such as correcting the small sampling delay across channels that some systems (e.g.&nbsp;Neuropixels) introduce or applying motion correction (note that this only corrects motion within, not across, recordings).</p>
<div id="12523893" class="cell" data-execution_count="8">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, recording <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(recordings):</span>
<span id="cb11-2">    recording <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> spre.bandpass_filter(recording, freq_min<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">300</span>, freq_max<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3000</span>)</span>
<span id="cb11-3">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># recording = spre.phase_shift(recording)</span></span>
<span id="cb11-4">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># recording = spre.correct_motion(recording, preset="nonrigid_fast_and_accurate")</span></span>
<span id="cb11-5">    recordings[i] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> recording</span>
<span id="cb11-6">recordings</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<pre><code>[GroundTruthRecording (BandpassFilterRecording): 12 channels - 25.0kHz - 1 segments 
                       250,000 samples - 10.00s - float32 dtype - 11.44 MiB,
 GroundTruthRecording (BandpassFilterRecording): 12 channels - 25.0kHz - 1 segments 
                       250,000 samples - 10.00s - float32 dtype - 11.44 MiB,
 GroundTruthRecording (BandpassFilterRecording): 12 channels - 25.0kHz - 1 segments 
                       250,000 samples - 10.00s - float32 dtype - 11.44 MiB]</code></pre>
</div>
</div>
<p>Next, we calculate waveform templates from the recordings. To do this, we create an analyzer object by pairing each recording and sorting and compute <a href="https://spikeinterface.readthedocs.io/en/stable/modules/postprocessing.html#computing-extensions">“extensions”</a> that are added to the analyzer. These extensions partly depend on each other — for example, computing the <code>"templates"</code> extension requires the <code>"random_spikes"</code> extension to be computed. Important: UnitMatch expects the waveform to be symmetric around the spike, so when you use different values for <code>ms_before</code> and <code>ms_after</code>, you’ll have to set the respective parameter in UnitMatch.</p>
<div id="1b83dcfb" class="cell" data-execution_count="9">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1">analyzers <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb13-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> sorting, recording <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(sortings, recordings):</span>
<span id="cb13-3">    analyzer <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> si.create_sorting_analyzer(sorting, recording, sparse<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb13-4">    analyzer.compute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"random_spikes"</span>, method<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"uniform"</span>, max_spikes_per_unit<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span>)</span>
<span id="cb13-5">    analyzer.compute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"templates"</span>, ms_before<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, ms_after<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb13-6">    analyzers.append(analyzer)</span>
<span id="cb13-7">analyzers</span></code></pre></div></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"fe6581edb00a405ab27c604c916c84ed","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"a79ebaa34e354b859ac78323a10befed","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"ceeec67572604a758727599324404d3d","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display" data-execution_count="9">
<pre><code>[SortingAnalyzer: 12 channels - 10 units - 1 segments - memory - has recording
 Loaded 2 extensions: random_spikes, templates,
 SortingAnalyzer: 12 channels - 10 units - 1 segments - memory - has recording
 Loaded 2 extensions: random_spikes, templates,
 SortingAnalyzer: 12 channels - 10 units - 1 segments - memory - has recording
 Loaded 2 extensions: random_spikes, templates]</code></pre>
</div>
</div>
<p>Let’s look at two of the extracted templates. In the figure below, we can clearly see one unit that has a large amplitude and is visible across all channels, and another one with a weak and noisy signal.</p>
<div id="cell-fig-units" class="cell" data-execution_count="10">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1">templates <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> analyzers[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].get_extension(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"templates"</span>).get_data()</span>
<span id="cb15-2">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>), sharex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, sharey<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb15-3"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, uid <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]):</span>
<span id="cb15-4">    ax[i].plot(templates[uid, :, :])</span>
<span id="cb15-5">    ax[i].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Unit </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>uid<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb15-6">ax[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(ylabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r"Voltage </span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">[$</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">\m</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">u$V]</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb15-7">ax[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(xlabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Time [samples]"</span>)</span></code></pre></div></div>
<div class="cell-output cell-output-display">
<div id="fig-units" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-units-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/fig-units-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3" title="Figure&nbsp;3: The average waveforms of two units extracted from recording 1."><img src="https://olebialas.github.io/posts/2024-10-02-unitmatch/index_files/figure-html/fig-units-output-1.png" width="537" height="302" class="figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-units-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: The average waveforms of two units extracted from recording 1.
</figcaption>
</figure>
</div>
</div>
</div>
<p>To remove the latter unit and others like it, we compute <code>"quality_metrics"</code> and select only those units that meet our quality criteria. Since most quality criteria (like ISI violations) don’t apply to simulated data, we’ll use only signal-to-noise ratio for unit selection. However, for real data that is probably insufficient — I recommend <a href="https://allensdk.readthedocs.io/en/latest/_static/examples/nb/ecephys_quality_metrics.html">this notebook</a> for an overview and discussion of different quality criteria.</p>
<div class="cell" data-execution_count="11">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1">min_snr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span></span>
<span id="cb16-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, analyzer <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(analyzers):</span>
<span id="cb16-3">    analyzer.compute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"noise_levels"</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># required to compute SNR</span></span>
<span id="cb16-4">    analyzer.compute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"quality_metrics"</span>, metric_names<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"snr"</span>])</span>
<span id="cb16-5">    metrics <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> analyzer.get_extension(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"quality_metrics"</span>).get_data()</span>
<span id="cb16-6">    keep_mask <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> metrics.snr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> min_snr</span>
<span id="cb16-7">    keep_unit_ids <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sorting.unit_ids[keep_mask]</span>
<span id="cb16-8">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Keeping </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(keep_unit_ids)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> out of </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(sorting.unit_ids)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> units"</span>)</span>
<span id="cb16-9">    sortings[i] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sortings[i].select_units(keep_unit_ids)</span>
<span id="cb16-10"></span>
<span id="cb16-11">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots()</span>
<span id="cb16-12">ax.hist(metrics.snr)</span>
<span id="cb16-13">ax.axvline(x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>min_snr, ymin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, ymax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"red"</span>, linestyle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"--"</span>)</span>
<span id="cb16-14">ax.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(ylabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Number of Units"</span>, xlabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"SNR"</span>, title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"SNR Distribution in Recording 3"</span>)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>Keeping 8 out of 10 units</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Keeping 8 out of 10 units</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Keeping 8 out of 10 units</code></pre>
</div>
<div id="fig-hist" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="11">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-hist-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div id="fig-hist-1" class="cell-output cell-output-display quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-hist-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"148baa2af5c14e5db83abce39fe6b3b0","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-hist-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) Histogram of the signal-to-noise ratio across all units. Units with a SNR below the red dashed line are removed.
</figcaption>
</figure>
</div>
<div id="fig-hist-2" class="cell-output cell-output-display quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-hist-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"4b6c4c8939eb42d0804c287962cea5ce","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-hist-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b)
</figcaption>
</figure>
</div>
<div id="fig-hist-3" class="cell-output cell-output-display quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-hist-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"5a61e5a456f94239ae4ccc3ac7257a8f","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-hist-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(c)
</figcaption>
</figure>
</div>
<div id="fig-hist-4" class="cell-output cell-output-display quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="11">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-hist-4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<pre><code>[Text(0, 0.5, 'Number of Units'),
 Text(0.5, 0, 'SNR'),
 Text(0.5, 1.0, 'SNR Distribution in Recording 3')]</code></pre>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-hist-4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(d)
</figcaption>
</figure>
</div>
<div class="cell-output cell-output-display">
<div id="fig-hist-5" class="quarto-float quarto-figure quarto-figure-center anchored" width="597" height="449">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-hist-5-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/fig-hist-output-8.png" class="lightbox" data-gallery="fig-hist" title="Figure&nbsp;4&nbsp;(e): "><img src="https://olebialas.github.io/posts/2024-10-02-unitmatch/index_files/figure-html/fig-hist-output-8.png" id="fig-hist-5" data-ref-parent="fig-hist" width="597" height="449" class="figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-hist-5-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(e)
</figcaption>
</figure>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-hist-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4
</figcaption>
</figure>
</div>
</div>
</section>
<section id="preparing-the-data-for-unitmatch" class="level2">
<h2 class="anchored" data-anchor-id="preparing-the-data-for-unitmatch">Preparing the Data for UnitMatch</h2>
<p>Next, we convert SpikeInterface data to UnitMatch’s expected format. First, we create a directory <code>"UMInputData"</code> with a subdirectory for each session and a <code>"RawWaveforms"</code> subdirectory in each session’s directory.</p>
<div id="712f7482" class="cell" data-execution_count="12">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1">UM_input_dir <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Path(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"UMInputData"</span>).absolute()</span>
<span id="cb21-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(recordings)):</span>
<span id="cb21-3">    session_dir <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> UM_input_dir <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Session</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb21-4">    (session_dir <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RawWaveforms"</span>).mkdir(parents<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, exist_ok<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb21-5"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>tree UMInputData</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<div class="ansi-escaped-output">
<pre><span class="ansi-blue-fg ansi-bold">UMInputData</span>

├── <span class="ansi-blue-fg ansi-bold">Session1</span>

│&nbsp;&nbsp; └── <span class="ansi-blue-fg ansi-bold">RawWaveforms</span>

├── <span class="ansi-blue-fg ansi-bold">Session2</span>

│&nbsp;&nbsp; └── <span class="ansi-blue-fg ansi-bold">RawWaveforms</span>

└── <span class="ansi-blue-fg ansi-bold">Session3</span>

    └── <span class="ansi-blue-fg ansi-bold">RawWaveforms</span>



7 directories, 0 files
</pre>
</div>
</div>
</div>
<p>Next, we need to extract the channel locations from every recording and store them in the session directory as <code>"channel_positions.npy"</code>.</p>
<div id="a99320f8" class="cell" data-execution_count="13">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, (recording, sorting) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(recordings, sortings)):</span>
<span id="cb22-2">    channel_locations <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> recording.get_channel_locations()</span>
<span id="cb22-3">    np.save(UM_input_dir <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Session</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"channel_positions.npy"</span>, channel_locations)</span></code></pre></div></div>
</div>
<p>Next, we create a table for each recording storing the original cluster ID of each unit (as assigned by the spike sorter) and the “group” to which it belongs. For the simulated data, all units are labeled <code>"good"</code> but for actual recordings you may want to label some as <code>"mua"</code> (multi-unit activity). The table is stored in the session directory as <code>"cluster_group.tsv"</code>.</p>
<div id="53b78c83" class="cell" data-execution_count="14">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, (recording, sorting) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(recordings, sortings)):</span>
<span id="cb23-2">    n_units <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sorting.get_num_units()</span>
<span id="cb23-3">    cluster_group <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.stack((<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(n_units), [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"good"</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(n_units)]), axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb23-4">    cluster_group <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.vstack((np.array((<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cluster_id"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"group"</span>)), cluster_group))</span>
<span id="cb23-5">    np.savetxt(</span>
<span id="cb23-6">        UM_input_dir <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Session</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cluster_group.tsv"</span>, cluster_group, fmt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%s</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>, delimiter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\t</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb23-7">    )</span>
<span id="cb23-8">cluster_group</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="14">
<pre><code>array([['cluster_id', 'group'],
       ['0', 'good'],
       ['1', 'good'],
       ['2', 'good'],
       ['3', 'good'],
       ['4', 'good'],
       ['5', 'good'],
       ['6', 'good'],
       ['7', 'good']], dtype='&lt;U21')</code></pre>
</div>
</div>
<p>Now comes the critical part: each recording and sorting has to be divided into two parts. UnitMatch calibrates the matching threshold by comparing units between the first and second half of each recording. We’ll split every recording and sorting into two and append the pieces to lists. From this, we obtain the lists of lists <code>split_recordings</code> and <code>split_sortings</code> where each element is a list with the first and second half of a given sorting/recording.</p>
<div id="ce927b66" class="cell" data-execution_count="15">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1">split_recordings, split_sortings <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [], []</span>
<span id="cb25-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> sorting, recording <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(sortings, recordings):</span>
<span id="cb25-3">    n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> recording.get_num_samples()</span>
<span id="cb25-4">    split_sortings.append(  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># split sortings</span></span>
<span id="cb25-5">        [</span>
<span id="cb25-6">            sorting.frame_slice(start_frame<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, end_frame<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 1st half</span></span>
<span id="cb25-7">            sorting.frame_slice(start_frame<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, end_frame<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>n),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 2nd half</span></span>
<span id="cb25-8">        ]</span>
<span id="cb25-9">    )</span>
<span id="cb25-10">    split_recordings.append(  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># split recordings</span></span>
<span id="cb25-11">        [</span>
<span id="cb25-12">            recording.frame_slice(start_frame<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, end_frame<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 1st half</span></span>
<span id="cb25-13">            recording.frame_slice(start_frame<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, end_frame<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>n),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 2nd half</span></span>
<span id="cb25-14">        ]</span>
<span id="cb25-15">    )</span>
<span id="cb25-16">split_sortings</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<pre><code>[[GroundTruthSorting (FrameSliceSorting): 8 units - 1 segments - 25.0kHz,
  GroundTruthSorting (FrameSliceSorting): 8 units - 1 segments - 25.0kHz],
 [GroundTruthSorting (FrameSliceSorting): 8 units - 1 segments - 25.0kHz,
  GroundTruthSorting (FrameSliceSorting): 8 units - 1 segments - 25.0kHz],
 [GroundTruthSorting (FrameSliceSorting): 8 units - 1 segments - 25.0kHz,
  GroundTruthSorting (FrameSliceSorting): 8 units - 1 segments - 25.0kHz]]</code></pre>
</div>
</div>
<p>For the half recordings and sortings, we’ll have to create new analyzers. The analyzers are stored in another list of lists called <code>split_analyzers</code>.</p>
<div id="4f02d25a" class="cell" data-execution_count="16">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1">split_analyzers <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb27-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> recording, sorting <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(split_recordings, split_sortings):</span>
<span id="cb27-3">    split_analyzers.append(</span>
<span id="cb27-4">        [</span>
<span id="cb27-5">            si.create_sorting_analyzer(sorting[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], recording[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], sparse<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>),</span>
<span id="cb27-6">            si.create_sorting_analyzer(sorting[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], recording[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], sparse<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>),</span>
<span id="cb27-7">        ]</span>
<span id="cb27-8">    )</span>
<span id="cb27-9">split_analyzers</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<pre><code>[[SortingAnalyzer: 12 channels - 8 units - 1 segments - memory - has recording
  Loaded 0 extensions,
  SortingAnalyzer: 12 channels - 8 units - 1 segments - memory - has recording
  Loaded 0 extensions],
 [SortingAnalyzer: 12 channels - 8 units - 1 segments - memory - has recording
  Loaded 0 extensions,
  SortingAnalyzer: 12 channels - 8 units - 1 segments - memory - has recording
  Loaded 0 extensions],
 [SortingAnalyzer: 12 channels - 8 units - 1 segments - memory - has recording
  Loaded 0 extensions,
  SortingAnalyzer: 12 channels - 8 units - 1 segments - memory - has recording
  Loaded 0 extensions]]</code></pre>
</div>
</div>
<p>We extract template waveforms from each half recording using the <code>split_analyzers</code>. We’ll compute the <code>"templates"</code> extension on every analyzer, stack the waveforms of the first and second half into a single array and append it to a list called <code>all_waveforms</code>. Each element in <code>all_waveforms</code> is a 4-dimensional numpy array where the dimensions represent units, samples, channels, and halves.</p>
<div id="7d152944" class="cell" data-execution_count="17">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1">all_waveforms <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb29-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> analyzer <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> split_analyzers:</span>
<span id="cb29-3">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># waveforms for 1st half</span></span>
<span id="cb29-4">    analyzer[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].compute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"random_spikes"</span>, method<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"uniform"</span>, max_spikes_per_unit<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span>)</span>
<span id="cb29-5">    analyzer[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].compute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"templates"</span>, ms_before<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, ms_after<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, n_jobs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>)</span>
<span id="cb29-6">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># waveforms for 2nd half</span></span>
<span id="cb29-7">    analyzer[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].compute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"random_spikes"</span>, method<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"uniform"</span>, max_spikes_per_unit<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span>)</span>
<span id="cb29-8">    analyzer[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].compute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"templates"</span>, ms_before<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, ms_after<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, n_jobs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>)</span>
<span id="cb29-9">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get waveform arrays and append them to list</span></span>
<span id="cb29-10">    all_waveforms.append(</span>
<span id="cb29-11">        np.stack(</span>
<span id="cb29-12">            (</span>
<span id="cb29-13">                analyzer[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].get_extension(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"templates"</span>).get_data(),</span>
<span id="cb29-14">                analyzer[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].get_extension(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"templates"</span>).get_data(),</span>
<span id="cb29-15">            ),</span>
<span id="cb29-16">            axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb29-17">        )</span>
<span id="cb29-18">    )</span>
<span id="cb29-19">all_waveforms[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].shape</span></code></pre></div></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"c70e7325c387471ab48b1ef2d3e67c7c","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"b66f6582dab84bbebe9e7a86b67c0f23","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"0c3479a131c94e1bad841c63962d4216","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"d6599753af3a443f93b72a631e89c0c6","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"34710001580c486dbd1450e102663516","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"90795dbcaad64fb8a4cc19066ea199b0","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display" data-execution_count="17">
<pre><code>(8, 100, 12, 2)</code></pre>
</div>
</div>
<p>Finally, we can save the waveforms to the session folders. For this, we’ll use the <code>save_avg_waveforms</code> function from UnitMatchPy. This function takes as arguments the average waveforms for a given session, the path to the session directory, as well as the previously created <code>cluster_group</code> table (so we’ll have to load that again). The <code>save_avg_waveforms</code> function will store one numpy array for every unit in the <code>RawWaveforms</code> subdirectory within the session directory.</p>
<div id="f682ef07" class="cell" data-execution_count="18">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(all_waveforms)):</span>
<span id="cb31-2">    session_dir <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> UM_input_dir <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Session</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb31-3">    cluster_group <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.loadtxt(  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># load table with good units</span></span>
<span id="cb31-4">        session_dir <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cluster_group.tsv"</span>, delimiter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\t</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>, dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb31-5">    )</span>
<span id="cb31-6">    um.extract_raw_data.save_avg_waveforms(</span>
<span id="cb31-7">        all_waveforms[i],</span>
<span id="cb31-8">        session_dir,</span>
<span id="cb31-9">        cluster_group,</span>
<span id="cb31-10">    )</span>
<span id="cb31-11"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>tree UMInputData<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>Session1</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<div class="ansi-escaped-output">
<pre>Saved 9 units to RawWaveforms directory, saving all units

Saved 9 units to RawWaveforms directory, saving all units

Saved 9 units to RawWaveforms directory, saving all units

<span class="ansi-blue-fg ansi-bold">UMInputData/Session1</span>

├── <span class="ansi-blue-fg ansi-bold">RawWaveforms</span>

│&nbsp;&nbsp; ├── Unit0_RawSpikes.npy

│&nbsp;&nbsp; ├── Unit1_RawSpikes.npy

│&nbsp;&nbsp; ├── Unit2_RawSpikes.npy

│&nbsp;&nbsp; ├── Unit3_RawSpikes.npy

│&nbsp;&nbsp; ├── Unit4_RawSpikes.npy

│&nbsp;&nbsp; ├── Unit5_RawSpikes.npy

│&nbsp;&nbsp; ├── Unit6_RawSpikes.npy

│&nbsp;&nbsp; └── Unit7_RawSpikes.npy

├── channel_positions.npy

└── cluster_group.tsv



2 directories, 10 files
</pre>
</div>
</div>
</div>
</section>
</section>
<section id="extracting-waveform-properties-and-matching-units" class="level1">
<h1>Extracting Waveform Properties and Matching Units</h1>
<p>With the data stored, we’re ready to run UnitMatch. The first step is to load the default parameters. The <code>param</code> dictionary contains the parameters for the UnitMatch algorithm and will be read and modified by multiple functions in the pipeline.</p>
<div id="28fb014e" class="cell" data-execution_count="19">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1">param <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> default_params.get_default_param()</span>
<span id="cb32-2">param.keys()</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="19">
<pre><code>dict_keys(['spike_width', 'waveidx', 'channel_radius', 'peak_loc', 'max_dist', 'neighbour_dist', 'stepsz', 'smooth_prob', 'min_angle_dist', 'min_new_shank_distance', 'units_per_shank_thrs', 'match_threshold', 'score_vector', 'bins'])</code></pre>
</div>
</div>
<p>Next, we create a list with the paths to our session folders and use the <code>paths_from_KS</code> function to get the paths to the waveforms, unit labels, and channel positions we previously stored (KS here stands for KiloSort — the spike sorter whose format the data is expected to conform to). Then, we’ll call <code>get_probe_geometry</code> which loads the probe information from the channel positions file and adds it to <code>param</code>.</p>
<div id="2eb794e1" class="cell" data-execution_count="20">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1">KS_dirs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(UM_input_dir <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Session</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(recordings))]</span>
<span id="cb34-2">wave_paths, unit_label_paths, channel_pos <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> um.utils.paths_from_KS(KS_dirs)</span>
<span id="cb34-3">param <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> um.utils.get_probe_geometry(channel_pos[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], param)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>Using cluster_group.tsv
Using cluster_group.tsv
Using cluster_group.tsv</code></pre>
</div>
</div>
<p>Finally, we use <code>load_good_waveforms</code> to load the waveforms of all units that are labeled as <code>"good"</code> in the cluster group table. The <code>session_id</code> array tells us which unit belongs to which session, <code>session_switch</code> tells us at which points the array switches from one session to another, and <code>within_session</code> is a 2D matrix that encodes which units were recorded in the same session.</p>
<div id="cell-fig-within" class="cell" data-execution_count="21">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb36" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1">waveform, session_id, session_switch, within_session, good_units, param <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (</span>
<span id="cb36-2">    um.utils.load_good_waveforms(wave_paths, unit_label_paths, param)</span>
<span id="cb36-3">)</span>
<span id="cb36-4">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots()</span>
<span id="cb36-5">ax.imshow(within_session)</span>
<span id="cb36-6">ax.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(xlabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Unit ID"</span>, ylabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Unit ID"</span>)</span></code></pre></div></div>
<div class="cell-output cell-output-display">
<div id="fig-within" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-within-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/fig-within-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-5" title="Figure&nbsp;5: Indicator matrix that shows whether units belong to the same (purple) or different (yellow) sessions."><img src="https://olebialas.github.io/posts/2024-10-02-unitmatch/index_files/figure-html/fig-within-output-1.png" width="433" height="429" class="figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-within-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5: Indicator matrix that shows whether units belong to the same (purple) or different (yellow) sessions.
</figcaption>
</figure>
</div>
</div>
</div>
<p>With data loaded in UnitMatch’s format, we can extract waveform parameters. The <code>extract_parameter</code> function takes as arguments the waveforms and channel positions, as well as a new dictionary <code>clus_info</code>, and returns a dictionary of <code>extracted_wave_properties</code>.</p>
<div id="7bfca3a9" class="cell" data-execution_count="22">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb37" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1">clus_info <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb37-2">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"good_units"</span>: good_units,</span>
<span id="cb37-3">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"session_switch"</span>: session_switch,</span>
<span id="cb37-4">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"session_id"</span>: session_id,</span>
<span id="cb37-5">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"original_ids"</span>: np.concatenate(good_units),</span>
<span id="cb37-6">}</span>
<span id="cb37-7">extracted_wave_properties <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> um.overlord.extract_parameters(</span>
<span id="cb37-8">    waveform, channel_pos, clus_info, param</span>
<span id="cb37-9">)</span></code></pre></div></div>
</div>
<p>Let’s visualize two of those properties: the site where maximum amplitude was recorded for a given unit, and the coefficient with which the amplitude of that unit decays as we move away from that site. If these properties allow us to match units across sessions, we should start to see some clusters. The points for the 1st and 2nd half of a recording should be close together and we should see triplets that represent the same unit across all three sessions. Some clusters clearly contain more units, but that is to be expected since we only plotted 2 out of the 10 extracted waveform properties.</p>
<div id="cell-fig-properties" class="cell" data-execution_count="23">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb38" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots()</span>
<span id="cb38-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>):</span>
<span id="cb38-3">    ax.scatter(</span>
<span id="cb38-4">        extracted_wave_properties[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"spatial_decay"</span>][:, i],</span>
<span id="cb38-5">        extracted_wave_properties[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"max_site"</span>][:, i],</span>
<span id="cb38-6">    )</span>
<span id="cb38-7">ax.legend(labels<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1st Half"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2nd Half"</span>])</span>
<span id="cb38-8">ax.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(xlabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Spatial Decay"</span>)</span>
<span id="cb38-9">ax.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(ylabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Maximum Site"</span>)</span></code></pre></div></div>
<div class="cell-output cell-output-display">
<div id="fig-properties" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-properties-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/fig-properties-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-6" title="Figure&nbsp;6: Spatial decay coefficient and site of maximum amplitude for each template waveform. Blue and orange dots show the waveforms from the first and second half of each recording respectively."><img src="https://olebialas.github.io/posts/2024-10-02-unitmatch/index_files/figure-html/fig-properties-output-1.png" width="585" height="429" class="figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-properties-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6: Spatial decay coefficient and site of maximum amplitude for each template waveform. Blue and orange dots show the waveforms from the first and second half of each recording respectively.
</figcaption>
</figure>
</div>
</div>
</div>
<p>UnitMatch computes a total similarity score T (0-1) combining similarity across all waveform properties for each unit pair. The <code>extract_metric_scores</code> returns a matrix of <code>total_score</code> values and an array of <code>candidate_pairs</code> that marks all units where the match score exceeds the threshold. This threshold is determined automatically based on the similarity of the waveforms within each recording.</p>
<div id="cell-fig-T" class="cell" data-execution_count="24">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb39" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1">total_score, candidate_pairs, scores_to_include, predictors <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (</span>
<span id="cb39-2">    um.overlord.extract_metric_scores(</span>
<span id="cb39-3">        extracted_wave_properties, session_switch, within_session, param, niter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb39-4">    )</span>
<span id="cb39-5">)</span>
<span id="cb39-6">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots()</span>
<span id="cb39-7">im <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ax.imshow(total_score)</span>
<span id="cb39-8">ax.contour(candidate_pairs, levels<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>], colors<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"red"</span>, linewidths<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>)</span>
<span id="cb39-9">ax.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(xlabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Unit ID"</span>, ylabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Unit ID"</span>)</span>
<span id="cb39-10">cbar <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.colorbar(im)</span>
<span id="cb39-11">cbar.set_label(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"T"</span>)</span></code></pre></div></div>
<div class="cell-output cell-output-display">
<div id="fig-t" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-t-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/fig-t-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-7" title="Figure&nbsp;7: Total similarity score for all pairs of units. Pairs where the score exceeds the threshold are marked red."><img src="https://olebialas.github.io/posts/2024-10-02-unitmatch/index_files/figure-html/fig-t-output-1.png" width="527" height="434" class="figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-t-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7: Total similarity score for all pairs of units. Pairs where the score exceeds the threshold are marked red.
</figcaption>
</figure>
</div>
</div>
</div>
<p>We now compute the prior probability that a random pair of units is a match, based on the number of putative matches that exceed the similarity score threshold.</p>
<div id="c253681c" class="cell" data-execution_count="25">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb40" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1">p_nomatch <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> (param[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n_expected_matches"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> param[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n_units"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb40-2">priors <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.array((p_nomatch, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> p_nomatch))</span>
<span id="cb40-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Prior probabilities: </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">P(no match): </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>priors[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">P(match): </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>priors[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>Prior probabilities: 
P(no match): 0.8715277777777778 
P(match): 0.1284722222222222</code></pre>
</div>
</div>
<p>Then we calculate the likelihood distributions of all features for matches and non-matches, i.e.&nbsp;P(feature | match) and P(feature | non-match). The <code>get_parameter_kernels</code> function returns a 3D array of shape (s, k, 2) where s is the score and k is the feature.</p>
<div id="cell-fig-distributions" class="cell" data-execution_count="26">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb42" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1">labels <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> candidate_pairs.astype(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>)</span>
<span id="cb42-2">cond <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.unique(labels)</span>
<span id="cb42-3">score_vector <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> param[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"score_vector"</span>]</span>
<span id="cb42-4">parameter_kernels <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> um.bayes_functions.get_parameter_kernels(</span>
<span id="cb42-5">    scores_to_include, labels, cond, param, add_one<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb42-6">)</span>
<span id="cb42-7"></span>
<span id="cb42-8">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots()</span>
<span id="cb42-9">ax.plot(score_vector, parameter_kernels[:, i, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Non-matches"</span>)</span>
<span id="cb42-10">ax.plot(score_vector, parameter_kernels[:, i, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Matches"</span>)</span>
<span id="cb42-11">plt.legend()</span>
<span id="cb42-12">ax.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(xlabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Spatial decay score"</span>, ylabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Density"</span>)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>Calculating the probability distributions of the metric scores</code></pre>
</div>
<div class="cell-output cell-output-display">
<div id="fig-distributions" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-distributions-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/fig-distributions-output-2.png" class="lightbox" data-gallery="quarto-lightbox-gallery-8" title="Figure&nbsp;8: Likelihood distributions of the spatial decay score for matching and non-matching units."><img src="https://olebialas.github.io/posts/2024-10-02-unitmatch/index_files/figure-html/fig-distributions-output-2.png" width="597" height="429" class="figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-distributions-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8: Likelihood distributions of the spatial decay score for matching and non-matching units.
</figcaption>
</figure>
</div>
</div>
</div>
<p>Finally, <code>apply_naive_bayes</code> multiplies feature likelihoods and applies Bayes’ theorem to compute the posterior probability that unit pairs match. The resulting probability matrix has the same shape as the similarity score matrix but its values are probabilities. We can select a probability threshold for units to be considered a match — here I use 0.9 but this is probably too strict for real data (in the original paper the authors use 0.5). Ideally, there should be three matches for every unit because it should match within each recording and across the other two recordings.</p>
<div id="cell-fig-matches" class="cell" data-execution_count="27">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb44" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1">probability <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> um.bayes_functions.apply_naive_bayes(</span>
<span id="cb44-2">    parameter_kernels, priors, predictors, param, cond</span>
<span id="cb44-3">)</span>
<span id="cb44-4">output_prob_matrix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> probability[:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].reshape(param[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n_units"</span>], param[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n_units"</span>])</span>
<span id="cb44-5">match_threshold <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span></span>
<span id="cb44-6">output_threshold <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.zeros_like(output_prob_matrix)</span>
<span id="cb44-7">output_threshold[output_prob_matrix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> match_threshold] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb44-8">plt.imshow(output_threshold, cmap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Greys"</span>)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>Calculating the match probabilities</code></pre>
</div>
<div class="cell-output cell-output-display">
<div id="fig-matches" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-matches-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/fig-matches-output-2.png" class="lightbox" data-gallery="quarto-lightbox-gallery-9" title="Figure&nbsp;9: Unit matches identified by thresholding the posterior probability that a pair of units is a match given its feature distribution."><img src="https://olebialas.github.io/posts/2024-10-02-unitmatch/index_files/figure-html/fig-matches-output-2.png" width="415" height="411" class="figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-matches-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;9: Unit matches identified by thresholding the posterior probability that a pair of units is a match given its feature distribution.
</figcaption>
</figure>
</div>
</div>
</div>
<p>The matrix of matches above shows a clear pattern of bands that run parallel to the diagonal. This is because, in our simulation, units have the same order across recordings. This would not be the case for real recordings where you would see a more random, scattered pattern.</p>
<section id="combining-matches-across-recordings" class="level2">
<h2 class="anchored" data-anchor-id="combining-matches-across-recordings">Combining Matches Across Recordings</h2>
<p>While the probability matrix shows pairwise matching probabilities, our goal is tracking units across recordings. This is what the <code>assign_unique_id</code> function does — it groups units identified as matches across recordings while applying three different strategies: - Liberal: Groups units if they match with ANY unit in the proposed group. - Default: Groups units if they match with EVERY unit in adjacent sessions. - Conservative: Groups units only if they match with EVERY other unit in the proposed group.</p>
<p>In our case, the default and conservative strategies are almost identical since there are only 3 sessions, but for a larger number of sessions there should be a notable difference. We’ll proceed with the liberal strategy, although the original paper recommends using the conservative strategy.</p>
<div id="c8b0980e" class="cell" data-execution_count="28">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb46" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1">matches <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.argwhere(output_threshold <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb46-2">UIDs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> um.assign_unique_id.assign_unique_id(output_prob_matrix, param, clus_info)</span>
<span id="cb46-3">unique_id <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> UIDs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># liberal strategy</span></span>
<span id="cb46-4">unique_id</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>Number of Liberal Matches: 26
Number of Intermediate Matches: 21
Number of Conservative Matches: 21</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="28">
<pre><code>array([ 0,  1,  2,  3,  4,  5,  5,  7,  0,  1,  2,  3, 12,  5,  5,  7,  0,
        1,  2,  3, 20,  5,  5,  7])</code></pre>
</div>
</div>
<p>Now, we combine all sortings using the <code>aggregate_units</code> function. Then, we identify matching units by identifying the locations of duplicates in the <code>unique_id</code> array. Finally, we use <code>MergeUnitsSorting</code> to merge and rename the units that have been matched. That’s it — now we have a sorting object that combines units across all sessions. The combined recording has 10 units despite only 8 surviving initial quality control. This shows that we were not able to find all existing matches (you can also see this from the missing squares in Figure&nbsp;9).</p>
<div id="b1394d4e" class="cell" data-execution_count="29">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb49" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1">sorting <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> aggregate_units(sortings)</span>
<span id="cb49-2">units_to_merge <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb49-3">new_unit_ids <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb49-4"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> uid <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> np.unique(unique_id):</span>
<span id="cb49-5">    idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.where(unique_id <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> uid)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb49-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(idx) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:</span>
<span id="cb49-7">        units_to_merge.append(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(sorting.unit_ids[idx]))</span>
<span id="cb49-8">        new_unit_ids.append(uid)</span>
<span id="cb49-9"></span>
<span id="cb49-10">sorting <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> MergeUnitsSorting(</span>
<span id="cb49-11">    sorting, units_to_merge<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>units_to_merge, new_unit_ids<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>new_unit_ids</span>
<span id="cb49-12">)</span>
<span id="cb49-13"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"After merging there are </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>sorting<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>get_num_units()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> units: </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>sorting<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>unit_ids<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>After merging there are 9 units: 
['4' '12' '20' '0' '1' '2' '3' '5' '7']</code></pre>
</div>
</div>
<p>UnitMatch also provides a <code>save_to_output</code> function that stores all of the estimated properties, distributions and probabilities. The cell below unpacks the <code>extracted_wave_properties</code> dictionary and saves the results to a folder called <code>"out"</code>.</p>
<div id="69fcb433" class="cell" data-execution_count="30">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb51" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1">save_dir <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"out"</span></span>
<span id="cb51-2">amplitude <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> extracted_wave_properties[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"amplitude"</span>]</span>
<span id="cb51-3">spatial_decay <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> extracted_wave_properties[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"spatial_decay"</span>]</span>
<span id="cb51-4">avg_centroid <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> extracted_wave_properties[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"avg_centroid"</span>]</span>
<span id="cb51-5">avg_waveform <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> extracted_wave_properties[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"avg_waveform"</span>]</span>
<span id="cb51-6">avg_waveform_per_tp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> extracted_wave_properties[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"avg_waveform_per_tp"</span>]</span>
<span id="cb51-7">wave_idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> extracted_wave_properties[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"good_wave_idxs"</span>]</span>
<span id="cb51-8">max_site <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> extracted_wave_properties[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"max_site"</span>]</span>
<span id="cb51-9">max_site_mean <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> extracted_wave_properties[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"max_site_mean"</span>]</span>
<span id="cb51-10">um.save_utils.save_to_output(</span>
<span id="cb51-11">    save_dir,</span>
<span id="cb51-12">    scores_to_include,</span>
<span id="cb51-13">    matches,</span>
<span id="cb51-14">    output_prob_matrix,</span>
<span id="cb51-15">    avg_centroid,</span>
<span id="cb51-16">    avg_waveform,</span>
<span id="cb51-17">    avg_waveform_per_tp,</span>
<span id="cb51-18">    max_site,</span>
<span id="cb51-19">    total_score,</span>
<span id="cb51-20">    output_threshold,</span>
<span id="cb51-21">    clus_info,</span>
<span id="cb51-22">    param,</span>
<span id="cb51-23">    UIDs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>UIDs,</span>
<span id="cb51-24">    save_match_table<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,</span>
<span id="cb51-25">)</span></code></pre></div></div>
</div>


</section>
</section>

<a onclick="window.scrollTo(0, 0); return false;" id="quarto-back-to-top"><i class="bi bi-arrow-up"></i> Back to top</a> ]]></description>
  <guid>https://olebialas.github.io/posts/2024-10-02-unitmatch/</guid>
  <pubDate>Thu, 09 Oct 2025 22:00:00 GMT</pubDate>
  <media:content url="https://olebialas.github.io/posts/2024-10-02-unitmatch/featured.png" medium="image" type="image/png" height="119" width="144"/>
</item>
<item>
  <title>Surveying Neural Spiking in Visual Cortex with Pandas and Seaborn</title>
  <dc:creator>Ole Bialas</dc:creator>
  <link>https://olebialas.github.io/posts/2025-09-03-psth_with_pandas/</link>
  <description><![CDATA[ 






<p>Modern electrophysiology equipment like the <a href="https://en.wikipedia.org/wiki/Neuropixels">Neuropixels probes</a> allows for simultaneous recording of hundreds of neurons. This leaves researchers with massive amounts of data to process and visualize. Fortunately, the Python ecosystem provides powerful tools for generating beautiful visualizations from large amounts of data in only a few lines of code. In this post, I’ll use data from a <a href="https://www.nature.com/articles/s41586-020-03171-x">2021 study by Joshua Siegle and colleagues</a><sup>1</sup>, conducted at the Allen Institute, where they recorded tens of thousands of neurons from six different cortical regions across multiple experimental conditions.</p>
<p>In this post, I’ll take the recordings from a single animal that was presented with bright flashes. I’ll visualize the responses across cortical regions in peri-stimulus time histograms (PSTHs) using Pandas and Seaborn. Why Pandas and Seaborn? While these libraries are not geared towards electrophysiological data, they offer established powerful tools for analyzing large amounts of data. A good understanding of Pandas and Seaborn will also be useful in a variety of scenarios since these libraries are widely used in academia and industry.</p>
<p>To follow along with my examples, install the required packages and download the data as described in the next section.</p>
<section id="prerequisites" class="level2">
<h2 class="anchored" data-anchor-id="prerequisites">Prerequisites</h2>
<p>First we have to install the required modules using <code>pip</code>:</p>
<pre><code>pip install numpy matplotlib seaborn pandas pyarrow</code></pre>
<p>Then, we can import the installed modules and download the data. We need two data frames — one containing the timing of the presented stimuli and another one containing the recorded spikes. Conveniently, all <code>read_</code> functions in Pandas accept URLs and can gracefully handle the downloading for us.</p>
<div id="33e5054f" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb2-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> matplotlib <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb2-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pandas <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pd</span>
<span id="cb2-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> seaborn <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> sns</span>
<span id="cb2-5"></span>
<span id="cb2-6">df_stimuli <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.read_parquet(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://uni-bonn.sciebo.de/s/G64EkHoQkeZeoLm/download"</span>)</span>
<span id="cb2-7">df_spikes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.read_parquet(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://uni-bonn.sciebo.de/s/mLMkb2TwbNx3Yg6/download"</span>)</span></code></pre></div></div>
</div>
</section>
<section id="referencing-spike-times-to-stimulus-presentations" class="level2">
<h2 class="anchored" data-anchor-id="referencing-spike-times-to-stimulus-presentations">Referencing Spike Times to Stimulus Presentations</h2>
<p>First, let’s take a look at the data. We have two data frames: <code>df_stimuli</code> contains the start and stop time for every stimulus <sup>2</sup> and <code>df_spikes</code> contains the unit ID, brain area and time for every recorded spike.</p>
<div class="cell" data-execution_count="2">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1">df_stimuli.head(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span></code></pre></div></div>
<div id="tbl-stim" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="2">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-stim-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;1: Stimuli
</figcaption>
<div aria-describedby="tbl-stim-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display" data-execution_count="2">
<div>


<table class="dataframe do-not-create-environment cell caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">start_time</th>
<th data-quarto-table-cell-role="th">stop_time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>1276.297013</td>
<td>1276.547221</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>1280.300363</td>
<td>1280.550569</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>1286.305383</td>
<td>1286.555591</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>1290.308743</td>
<td>1290.558946</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>1294.312073</td>
<td>1294.562279</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</figure>
</div>
</div>
<div class="cell" data-execution_count="3">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1">df_spikes.head(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span></code></pre></div></div>
<div id="tbl-spikes" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="3">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-spikes-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;2: Recorded spikes
</figcaption>
<div aria-describedby="tbl-spikes-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display" data-execution_count="3">
<div>


<table class="dataframe do-not-create-environment cell caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">unit_id</th>
<th data-quarto-table-cell-role="th">brain_area</th>
<th data-quarto-table-cell-role="th">spike_time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>951031334</td>
<td>LM</td>
<td>1276.297339</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>951031154</td>
<td>LM</td>
<td>1276.298206</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>951031243</td>
<td>LM</td>
<td>1276.298739</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>951021543</td>
<td>PM</td>
<td>1276.299007</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>951031253</td>
<td>LM</td>
<td>1276.301272</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</figure>
</div>
</div>
<p>To be able to relate the spiking to the presented stimuli, we have to combine the information from Table&nbsp;1 and Table&nbsp;2. To do this, we first create a new column in the stimulus dataframe called <code>"analysis_window_start"</code><sup>3</sup> which is simply the stimulus onset minus 0.5 seconds. Then, we use <code>pd.merge_asof()</code> to match every spike with the closest analysis window. In the merged data frame <code>df</code>, we subtract the stimulus start time from the spike time which gives us the spike time relative to the stimulus. Finally, we remove all relative spike time values greater than 1 and remove the columns we don’t need. The final dataframe contains all spikes happening between 0.5 seconds before and 1.0 seconds after stimulus onset.</p>
<div class="cell" data-execution_count="4">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1">df_stimuli[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"analysis_window_start"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df_stimuli.start_time <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span></span>
<span id="cb5-2">df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.merge_asof(</span>
<span id="cb5-3">    df_spikes, df_stimuli, left_on<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"spike_time"</span>, right_on<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"analysis_window_start"</span></span>
<span id="cb5-4">)</span>
<span id="cb5-5">df.spike_time <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-=</span> df.start_time</span>
<span id="cb5-6">df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df[df.spike_time <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>]</span>
<span id="cb5-7">df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"spike_time"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"brain_area"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"unit_id"</span>]]</span>
<span id="cb5-8">df.sample(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span></code></pre></div></div>
<div id="tbl-merged" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="4">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-merged-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;3: Spike times relative to stimulus onset
</figcaption>
<div aria-describedby="tbl-merged-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display" data-execution_count="4">
<div>


<table class="dataframe do-not-create-environment cell caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">spike_time</th>
<th data-quarto-table-cell-role="th">brain_area</th>
<th data-quarto-table-cell-role="th">unit_id</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">365421</th>
<td>0.000291</td>
<td>PM</td>
<td>951021314</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">208777</th>
<td>0.372630</td>
<td>PM</td>
<td>951021469</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">108261</th>
<td>0.081441</td>
<td>AM</td>
<td>951017432</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">402572</th>
<td>-0.250033</td>
<td>AL</td>
<td>951035799</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">156489</th>
<td>0.783751</td>
<td>AL</td>
<td>951035530</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</figure>
</div>
</div>
</section>
<section id="creating-a-peri-stimulus-time-histogram" class="level2">
<h2 class="anchored" data-anchor-id="creating-a-peri-stimulus-time-histogram">Creating a Peri-Stimulus Time Histogram</h2>
<p>Now we can quantify how the spiking changes in response to the stimulus. To do this, we create an array of 10 millisecond wide bins between -0.5 and 1.0 seconds, group the data by unit ID and brain area and count the spike time values that fall into each bin. Finally, we reset the index of the returned series, take the middle of each bin and rename the columns. The resulting dataframe contains the spike count for every unit in every bin.</p>
<div class="cell" data-execution_count="5">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1">bins <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.arange(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>)</span>
<span id="cb6-2">psth <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (</span>
<span id="cb6-3">    df.groupby([<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"unit_id"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"brain_area"</span>])</span>
<span id="cb6-4">    .spike_time.value_counts(bins<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>bins)</span>
<span id="cb6-5">    .reset_index()</span>
<span id="cb6-6">)</span>
<span id="cb6-7">psth.spike_time <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> psth.spike_time.array.mid</span>
<span id="cb6-8">psth.columns <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"unit_id"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"brain_area"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bin_time"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"spike_count"</span>]</span>
<span id="cb6-9">psth.sample(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span></code></pre></div></div>
<div id="tbl-psth" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="5">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-psth-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;4: Peri-stimulus time histogram
</figcaption>
<div aria-describedby="tbl-psth-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display" data-execution_count="5">
<div>


<table class="dataframe do-not-create-environment cell caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">unit_id</th>
<th data-quarto-table-cell-role="th">brain_area</th>
<th data-quarto-table-cell-role="th">bin_time</th>
<th data-quarto-table-cell-role="th">spike_count</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">32133</th>
<td>951027638</td>
<td>V1</td>
<td>0.415</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">44260</th>
<td>951035018</td>
<td>AL</td>
<td>-0.455</td>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">17535</th>
<td>951021725</td>
<td>PM</td>
<td>0.785</td>
<td>2</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1466</th>
<td>951015854</td>
<td>AM</td>
<td>0.265</td>
<td>1</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4910</th>
<td>951016603</td>
<td>AM</td>
<td>0.455</td>
<td>0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</figure>
</div>
</div>
<p>To visualize the PSTH, we’ll use seaborn’s <code>relplot()</code> function to plot the spike counts against the bin times. We can also add reference lines at 0 and 0.25 seconds that mark the stimulus onset and offset. There is a clear pattern — spiking increases after the onset, falls back to baseline, increases again after the offset, drops below the baseline and then rebounds.</p>
<div id="cell-fig-average_psth" class="cell" data-execution_count="6">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1">g <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sns.relplot(data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>psth, x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bin_time"</span>, y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"spike_count"</span>, kind<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"line"</span>)</span>
<span id="cb7-2">g.refline(x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>, linestyle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"--"</span>, alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>)</span>
<span id="cb7-3">g.refline(x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>, linestyle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"--"</span>, alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>)</span></code></pre></div></div>
<div class="cell-output cell-output-display">
<div id="fig-average_psth" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-average_psth-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/fig-average_psth-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1" title="Figure&nbsp;1: Average time-binned spike count between 500 ms before and 1000 ms after stimulus onset. The shaded interval shows the 95% confidence-interval and the vertical dashed lines show the stimulus onset (0 s) and offset (0.25 s)."><img src="https://olebialas.github.io/posts/2025-09-03-psth_with_pandas/index_files/figure-html/fig-average_psth-output-1.png" width="469" height="468" class="figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-average_psth-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Average time-binned spike count between 500 ms before and 1000 ms after stimulus onset. The shaded interval shows the 95% confidence-interval and the vertical dashed lines show the stimulus onset (0 s) and offset (0.25 s).
</figcaption>
</figure>
</div>
</div>
</div>
<p>We can also add a <code>hue</code> to encode the brain area and zoom in on the x-axis in order to make out differences in the spiking profile between brain areas (we’ll set <code>errorbar=None</code> because the overlapping confidence intervals will make the plot hard to read).</p>
<div id="cell-fig-area_psth" class="cell" data-execution_count="7">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1">g <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sns.relplot(data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>psth, x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bin_time"</span>, y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"spike_count"</span>, kind<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"line"</span> , hue<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"brain_area"</span>, errorbar<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>)</span>
<span id="cb8-2">g.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(xlim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>))</span></code></pre></div></div>
<div class="cell-output cell-output-display">
<div id="fig-area_psth" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-area_psth-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/fig-area_psth-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2" title="Figure&nbsp;2: Average time-binned spike count between 500 ms before and 1000 ms after stimulus onset for each visual cortex area."><img src="https://olebialas.github.io/posts/2025-09-03-psth_with_pandas/index_files/figure-html/fig-area_psth-output-1.png" width="550" height="468" class="figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-area_psth-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Average time-binned spike count between 500 ms before and 1000 ms after stimulus onset for each visual cortex area.
</figcaption>
</figure>
</div>
</div>
</div>
<p>We can see that spiking in the primary visual cortex V1 peaks first which is expected since it represents the lowest level in the visual processing hierarchy. However, there are large differences in the average firing rate between areas which makes this plot hard to read. To overcome this limitation we have to apply baseline correction.</p>
</section>
<section id="applying-a-baseline-correction" class="level2">
<h2 class="anchored" data-anchor-id="applying-a-baseline-correction">Applying a Baseline Correction</h2>
<p>To compute the baselines, we select all spikes that happen before 0 seconds (i.e.&nbsp;the stimulus onset), group the data by unit ID and calculate the mean spike count to obtain an estimate of each unit’s average firing rate in absence of the stimulus. Then, we merge the baseline estimates with the PSTH and create a new column called <code>"spike_count_change"</code> by subtracting the baseline from the spike count.</p>
<div class="cell" data-execution_count="8">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1">baseline <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> psth[psth.bin_time <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].groupby([<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"unit_id"</span>]).spike_count.mean()</span>
<span id="cb9-2">baseline.name <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"baseline"</span></span>
<span id="cb9-3">psth <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> psth.merge(baseline, on<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"unit_id"</span>)</span>
<span id="cb9-4">psth[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"spike_count_change"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> psth.spike_count <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> psth.baseline</span>
<span id="cb9-5">psth.sample(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span></code></pre></div></div>
<div id="tbl-baseline" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="8">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-baseline-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;5: Baseline-corrected spike counts
</figcaption>
<div aria-describedby="tbl-baseline-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display" data-execution_count="8">
<div>


<table class="dataframe do-not-create-environment cell caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">unit_id</th>
<th data-quarto-table-cell-role="th">brain_area</th>
<th data-quarto-table-cell-role="th">bin_time</th>
<th data-quarto-table-cell-role="th">spike_count</th>
<th data-quarto-table-cell-role="th">baseline</th>
<th data-quarto-table-cell-role="th">spike_count_change</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">11666</th>
<td>951020899</td>
<td>PM</td>
<td>-0.285</td>
<td>9</td>
<td>8.62</td>
<td>0.38</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">11462</th>
<td>951018301</td>
<td>AM</td>
<td>0.885</td>
<td>0</td>
<td>0.00</td>
<td>0.00</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">44134</th>
<td>951035003</td>
<td>AL</td>
<td>-0.345</td>
<td>14</td>
<td>13.62</td>
<td>0.38</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">644</th>
<td>951015731</td>
<td>AM</td>
<td>-0.075</td>
<td>0</td>
<td>0.00</td>
<td>0.00</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">27814</th>
<td>951026880</td>
<td>V1</td>
<td>-0.415</td>
<td>11</td>
<td>13.88</td>
<td>-2.88</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</figure>
</div>
</div>
<p>Now we can recreate our area-specific PSTH plot using the spike count change — the result looks much clearer!</p>
<div id="cell-fig-baseline_psth" class="cell" data-execution_count="9">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1">g <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sns.relplot(</span>
<span id="cb10-2">    data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>psth,</span>
<span id="cb10-3">    x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bin_time"</span>,</span>
<span id="cb10-4">    y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"spike_count_change"</span>,</span>
<span id="cb10-5">    kind<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"line"</span>,</span>
<span id="cb10-6">    hue<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"brain_area"</span>,</span>
<span id="cb10-7">    errorbar<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>,</span>
<span id="cb10-8">)</span>
<span id="cb10-9">g.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(xlim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>))</span></code></pre></div></div>
<div class="cell-output cell-output-display">
<div id="fig-baseline_psth" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-baseline_psth-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/fig-baseline_psth-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3" title="Figure&nbsp;3: Baseline-corrected changes in spike count between 100 ms before and 500 ms after stimulus onset across brain areas."><img src="https://olebialas.github.io/posts/2025-09-03-psth_with_pandas/index_files/figure-html/fig-baseline_psth-output-1.png" width="548" height="468" class="figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-baseline_psth-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: Baseline-corrected changes in spike count between 100 ms before and 500 ms after stimulus onset across brain areas.
</figcaption>
</figure>
</div>
</div>
</div>
<p>However, there is still a problem: the number of units that respond to the stimulus varies across brain areas as higher visual areas generally respond less to simple flashes which confounds our analysis. In order to interpret the absolute spike counts we need to identify the units that actually respond to the stimuli.</p>
</section>
<section id="identifying-responsive-units" class="level2">
<h2 class="anchored" data-anchor-id="identifying-responsive-units">Identifying Responsive Units</h2>
<p>To identify the responsive units, we first compute the relative change in spiking by dividing the baseline subtracted spikecount by the baseline. We add a small regularization coefficient <img src="https://latex.codecogs.com/png.latex?%5Cepsilon"> to avoid that baseline values close to 0 inflate the estimate <sup>4</sup>. Then, we can plot the relative change in spiking for every unit (this requires setting <code>estimator=None</code>). Let’s add a horizontal line to mark the threshold for responsiveness — in this example, we want to consider a unit responsive if its relative spike count increases 5 times with respect to the baseline. This method of identifying responsive units is not statistically rigorous, but it is a quick and convenient way of filtering the data for visualization.</p>
<div id="cell-fig-relative_psth" class="cell" data-execution_count="10">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1">epsilon <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span></span>
<span id="cb11-2">threshold <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span></span>
<span id="cb11-3">psth[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rel_spike_count_change"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (psth.spike_count <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> psth.baseline) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (</span>
<span id="cb11-4">    psth.baseline <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> epsilon</span>
<span id="cb11-5">)</span>
<span id="cb11-6">g <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sns.relplot(</span>
<span id="cb11-7">    psth,</span>
<span id="cb11-8">    x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bin_time"</span>,</span>
<span id="cb11-9">    y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rel_spike_count_change"</span>,</span>
<span id="cb11-10">    units<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"unit_id"</span>,</span>
<span id="cb11-11">    kind<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"line"</span>,</span>
<span id="cb11-12">    estimator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>,</span>
<span id="cb11-13">)</span>
<span id="cb11-14">g.refline(y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>threshold, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>, linestyle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"--"</span>, alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>)</span></code></pre></div></div>
<div class="cell-output cell-output-display">
<div id="fig-relative_psth" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-relative_psth-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/fig-relative_psth-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-4" title="Figure&nbsp;4: Each unit’s change in the time-binned spike counts relative to the baseline. The horizontal line marks the threshold above which a unit is considered responsive."><img src="https://olebialas.github.io/posts/2025-09-03-psth_with_pandas/index_files/figure-html/fig-relative_psth-output-1.png" width="469" height="468" class="figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-relative_psth-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4: Each unit’s change in the time-binned spike counts relative to the baseline. The horizontal line marks the threshold above which a unit is considered responsive.
</figcaption>
</figure>
</div>
</div>
</div>
<p>Now, we group the data by unit ID and check whether each unit’s maximum value for the relative change in spike count is above the selected threshold. Then, we merge the result with the PSTH to get a new column with boolean values that indicate whether any given unit is responsive. Finally, we can reproduce Figure&nbsp;3 selecting only the units that are responsive according to our threshold criterion.</p>
<div id="cell-fig-responsive_psth" class="cell" data-execution_count="11">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1">is_responsive <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> psth.groupby([<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"unit_id"</span>]).rel_spike_count_change.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> threshold</span>
<span id="cb12-2">is_responsive.name <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"is_responsive"</span></span>
<span id="cb12-3">psth <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> psth.merge(is_responsive, on<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"unit_id"</span>)</span>
<span id="cb12-4">g <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sns.relplot(</span>
<span id="cb12-5">    data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>psth[psth.is_responsive],</span>
<span id="cb12-6">    x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bin_time"</span>,</span>
<span id="cb12-7">    y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"spike_count_change"</span>,</span>
<span id="cb12-8">    kind<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"line"</span>,</span>
<span id="cb12-9">    hue<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"brain_area"</span>,</span>
<span id="cb12-10">    errorbar<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>,</span>
<span id="cb12-11">)</span>
<span id="cb12-12">g.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(xlim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>))</span></code></pre></div></div>
<div class="cell-output cell-output-display">
<div id="fig-responsive_psth" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-responsive_psth-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/fig-responsive_psth-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-5" title="Figure&nbsp;5: Baseline-corrected changes in spike count in units with an above-threshold response to the stimuli. Note that there are only 5 brain areas since no neuron from area RL exceeded the threshold."><img src="https://olebialas.github.io/posts/2025-09-03-psth_with_pandas/index_files/figure-html/fig-responsive_psth-output-1.png" width="549" height="468" class="figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-responsive_psth-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5: Baseline-corrected changes in spike count in units with an above-threshold response to the stimuli. Note that there are only 5 brain areas since no neuron from area RL exceeded the threshold.
</figcaption>
</figure>
</div>
</div>
</div>
<p>Now the differences in response latency between the areas are much clearer. We can also make out some interesting trends — for example, units in V1 appear to respond mostly to the stimulus onset while units in LM respond more strongly to the offset.</p>
</section>
<section id="closing-remarks" class="level2">
<h2 class="anchored" data-anchor-id="closing-remarks">Closing Remarks</h2>
<p>The goal of this post was to show how you can use Pandas and Seaborn to create detailed and informative graphs from large datasets (i.e.&nbsp;tables with hundreds of thousands of rows) with relatively little code. The methods for data aggregation, merging and visualization shown here will be applicable to any data that can be arranged in a tabular format. What this demo lacks is a statistical comparison of the spiking activity between brain areas. This was outside of the scope of this post since I only used data from a single animal. If you are interested in working with the full dataset you can check out my <a href="https://github.com/OleBialas/Ecephys-Recordings-from-Mouse-Visual-System">GitHub repo</a> which contains the recordings from over 50 animals in the same data format used in this demo.</p>


</section>


<a onclick="window.scrollTo(0, 0); return false;" id="quarto-back-to-top"><i class="bi bi-arrow-up"></i> Back to top</a><div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Siegle, J. H., Jia, X., Durand, S., Gale, S., Bennett, C., Graddis, N., … &amp; Koch, C. (2021). Survey of spiking in the mouse visual system reveals functional hierarchy. Nature, 592(7852), 86-92.↩︎</p></li>
<li id="fn2"><p>All stimuli are full-field flashes so there isn’t any relevant information besides the stimuli’s timing↩︎</p></li>
<li id="fn3"><p>We could skip creating the <code>"analysis_window_start"</code> column and merge the data using the stimulus onsets. However, then we would lose the spikes that occur right before the onset which we need to compute the baseline.↩︎</p></li>
<li id="fn4"><p>The exact value of <img src="https://latex.codecogs.com/png.latex?%5Cepsilon"> is not that relevant here, so feel free to try out different values. However, be aware that larger values of <img src="https://latex.codecogs.com/png.latex?%5Cepsilon"> will lead to smaller values of the relative change in spike count for all units, so you’ll have to adapt the threshold as well.↩︎</p></li>
</ol>
</section></div> ]]></description>
  <guid>https://olebialas.github.io/posts/2025-09-03-psth_with_pandas/</guid>
  <pubDate>Tue, 02 Sep 2025 22:00:00 GMT</pubDate>
  <media:content url="https://olebialas.github.io/posts/2025-09-03-psth_with_pandas/featured.png" medium="image" type="image/png" height="123" width="144"/>
</item>
<item>
  <title>EEG preprocessing II: eye-artifacts, repairing and rejecting</title>
  <dc:creator>Ole Bialas</dc:creator>
  <link>https://olebialas.github.io/posts/2024-02-23-eeg_preprocessing_2/</link>
  <description><![CDATA[ 






<p>The <a href="posts/eeg_preprocessing">previous post on preprocessing EEG</a> presented a minimally invasive pipeline of procedures that are necessary in most EEG analyses. In this post I present additional steps that might be useful if the data is still not <strong>sufficiently cleaned</strong>. First, I will address <strong>eye blinks</strong> which is one of the most prevalent sources of artifacts in EEG recordings. After that, I’ll demonstrate a method to repair or remove segments of the data <strong>contaminated with noise</strong>.</p>
<section id="prerequisites" class="level1">
<h1>Prerequisites</h1>
<p>First, we need to install some packages that provide us with the equired preprocessing functions:</p>
<pre><code>pip install mne meegkit pyprep autoreject</code></pre>
<p>Then, we have to dowload the sample data from MNE Python and clean it using the steps described <a href="posts/eeg_preprocessing">in the previous post on EEG preprocessing</a>. The code below does exactly that — if you want a more detailed explanation, read the original post. Running the cell below produces the cleaned <code>epochs</code> to which we will apply further preprocessing, starting with the removal of <strong>eye artifacts</strong>.</p>
<div id="3abfabe1" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb2-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> mne.io <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> read_raw_fif</span>
<span id="cb2-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> mne.datasets.sample <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> data_path</span>
<span id="cb2-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> mne <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> find_events</span>
<span id="cb2-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> mne.epochs <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Epochs</span>
<span id="cb2-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> meegkit.detrend <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> detrend</span>
<span id="cb2-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> meegkit.dss <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> dss_line</span>
<span id="cb2-8"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> pyprep.ransac <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> find_bad_by_ransac</span>
<span id="cb2-9"></span>
<span id="cb2-10">raw <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> read_raw_fif(data_path() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"MEG/sample/sample_audvis_raw.fif"</span>)</span>
<span id="cb2-11">events <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> find_events(raw)</span>
<span id="cb2-12">raw.pick(picks<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"eeg"</span>)</span>
<span id="cb2-13">raw, events <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> raw.resample(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">150</span>, events<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>events)</span>
<span id="cb2-14">X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> raw.get_data().T  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># transpose so the data is organized time-by-channels</span></span>
<span id="cb2-15">X, _, _ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> detrend(X, order<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb2-16">X, _, _ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> detrend(X, order<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>)</span>
<span id="cb2-17">raw._data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> X.T  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># overwrite raw data</span></span>
<span id="cb2-18">X, noise <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dss_line(X, fline<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">60</span>, sfreq<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>raw.info[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sfreq"</span>], nremove<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span>
<span id="cb2-19">raw._data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> X.T</span>
<span id="cb2-20">bads, _ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> find_bad_by_ransac(</span>
<span id="cb2-21">    data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>raw.get_data(),</span>
<span id="cb2-22">    sample_rate<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>raw.info[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sfreq"</span>],</span>
<span id="cb2-23">    complete_chn_labs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>np.asarray(raw.info[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ch_names"</span>]),</span>
<span id="cb2-24">    chn_pos<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>np.stack([ch[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"loc"</span>][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> ch <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> raw.info[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"chs"</span>]]),</span>
<span id="cb2-25">    exclude<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[],</span>
<span id="cb2-26">    corr_thresh<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span>,</span>
<span id="cb2-27">)</span>
<span id="cb2-28">raw_clean <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> raw.copy()</span>
<span id="cb2-29">raw_clean.info[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bads"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> bads</span>
<span id="cb2-30">raw_clean.interpolate_bads()</span>
<span id="cb2-31">raw_clean.set_eeg_reference(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"average"</span>, projection<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># compute the reference</span></span>
<span id="cb2-32">raw.add_proj(raw_clean.info[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"projs"</span>][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])</span>
<span id="cb2-33"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">del</span> raw_clean  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># delete the copy</span></span>
<span id="cb2-34">raw.apply_proj()  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># apply the reference</span></span>
<span id="cb2-35">event_id <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"auditory/left"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"auditory/right"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>}</span>
<span id="cb2-36">epochs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Epochs(raw, events, event_id, tmin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, tmax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>, baseline<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, preload<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span></code></pre></div></div>
</details>
</div>
</section>
<section id="what-are-eye-artifacts" class="level1">
<h1>What are eye artifacts?</h1>
<p>While it is often assumed that eye artifacts are the result of muscle activity, they are actually the result of a <strong>ionic gradient</strong> in the retinal pigment epithelium that makes the eye an <strong>electric dipole</strong> <sup>1</sup>. Thus, moving the eyes and the dipole <strong>induces</strong> a change in voltage picked up by the sensors that is roughly proportional to the <strong>amplitude</strong> of the movement. Because this could overshadow the neural responses, many studies eliminate eye movements by making participants <strong>fixate</strong> a point during the experiment.</p>
<p>However, another kind of eye artifact may still occur - <strong>blinks</strong>. Eye blinks affect the measured voltage because the eye lid <strong>changes the resistance</strong> between the positively charged cornea and the forehead. Fortunately, these eye artifacts are largely <strong>independent</strong> of each other and the brain activity which makes them ideal candidates for independent component analysis (ICA) <sup>2</sup>.</p>
</section>
<section id="identifying-eye-blink-components-with-ica" class="level1">
<h1>Identifying eye-blink components with ICA</h1>
<p>ICA is an algorithm that finds a rotation matrix to separate the sensor data into components that are <strong>mutually independent</strong> <sup>3</sup>. In the code below, I fit an ICA to the epoched data. At maximum, ICA can capture as many components as there are channels. However, usually the data can be captured with <strong>fewer components</strong>. When the <code>n_components</code> parameter is set to a decimal number, the ICA will compute as many components as are necessary to explain this share of the total variance in the data. Because highpass filtering improves the quality of artifact separation <sup>4</sup>, I use a highpass filtered copy of the data for ICA.</p>
<div id="1ed3a83c" class="cell" data-execution_count="2">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> matplotlib <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb3-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> mne.preprocessing <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ICA</span>
<span id="cb3-3">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span>
<span id="cb3-4">ica <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ICA(n_components<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.99</span>)</span>
<span id="cb3-5">ica.fit(epochs.copy().<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">filter</span>(l_freq<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, h_freq<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>))</span>
<span id="cb3-6">ica.plot_components(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>), axes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ax)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>Setting up high-pass filter at 2 Hz

FIR filter parameters
---------------------
Designing a one-pass, zero-phase, non-causal highpass filter:
- Windowed time-domain design (firwin) method
- Hamming window with 0.0194 passband ripple and 53 dB stopband attenuation
- Lower passband edge: 2.00
- Lower transition bandwidth: 2.00 Hz (-6 dB cutoff frequency: 1.00 Hz)
- Filter length: 249 samples (1.660 s)
</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Fitting ICA to data using 59 channels (please be patient, this may take a while)
    Applying projection operator with 1 vector (pre-whitener computation)
    Applying projection operator with 1 vector (pre-whitener application)
Selecting by explained variance: 32 components
    Applying projection operator with 1 vector (pre-whitener application)
Fitting ICA took 0.4s.</code></pre>
</div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-3-output-3.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1" title="The first 5 inpedendent components found by ICA. These account for most of the variance in the data"><img src="https://olebialas.github.io/posts/2024-02-23-eeg_preprocessing_2/index_files/figure-html/cell-3-output-3.png" width="540" height="137" alt="The first 5 inpedendent components found by ICA. These account for most of the variance in the data" class="figure-img"></a></p>
<figcaption>The first 5 inpedendent components found by ICA. These account for most of the variance in the data</figcaption>
</figure>
</div>
</div>
</div>
<p>The components are ordered by <strong>explained variance</strong>, so the first few components have the largest impact on the signal. Each component is a <strong>linear combination</strong> of all channels and the weights indicate how much each channel affects that component <sup>5</sup>. The first components depends almost solely on the <strong>frontal channels</strong> - a strong indicator that it represents eye-blink artifacts!</p>
<p>Another way to characterize the components is to obtain their <strong>time course</strong> by filtering the EEG signal using the component weights. The resulting time series is called the <strong>component loading</strong> and indicates the presence of that component in the data across time. In the code below, I compute the loading for all ICA components, select the first one and plot it after concatenating all epochs.</p>
<div id="16c5339f" class="cell" data-execution_count="3">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb6-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> matplotlib <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb6-3"></span>
<span id="cb6-4">src <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ica.get_sources(epochs)</span>
<span id="cb6-5">src <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> src.get_data()[:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, :].flatten()</span>
<span id="cb6-6">times <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.linspace(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(src) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> epochs.info[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sfreq"</span>], <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(src))</span>
<span id="cb6-7">plt.plot(times[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4000</span>], src[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4000</span>])</span>
<span id="cb6-8">plt.xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Time [s]"</span>)</span>
<span id="cb6-9">plt.ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Component loading [a.u.]"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>    Applying projection operator with 1 vector (pre-whitener application)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-4-output-2.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2" title="Loading of the components which indicates how active this component is throughout the recording"><img src="https://olebialas.github.io/posts/2024-02-23-eeg_preprocessing_2/index_files/figure-html/cell-4-output-2.png" width="585" height="433" alt="Loading of the components which indicates how active this component is throughout the recording" class="figure-img"></a></p>
<figcaption>Loading of the components which indicates how active this component is throughout the recording</figcaption>
</figure>
</div>
</div>
</div>
<p>The component loading is mostly flat except for <strong>large amplitude spikes</strong> - exactly what is expected from a signal that represents discrete eye blinks. After ensuring that the component captures blinks it can be removed from the data.</p>
</section>
<section id="automated-component-rejection" class="level1">
<h1>Automated component rejection</h1>
<p>One could simply select and remove the eye blink component from the data. However, manual selection of components goes against the idea of an automated preprocessing pipeline. Instead, we can use the selected component as a <strong>template</strong> and classify new components as blinks by using the <code>corrmap</code> algorithm which selects components who’s <strong>correlation</strong> with the template exceeds some <strong>threshold</strong> <sup>6</sup>. To do this we can can store the blink component’s index in the <code>ICA.labels_</code> attribute and save the ICA as template.</p>
<div id="2c543828" class="cell" data-execution_count="4">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> tempfile</span>
<span id="cb8-2">temp_dir <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tempfile.TemporaryDirectory()</span>
<span id="cb8-3">template <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ica.copy()</span>
<span id="cb8-4">template.labels_[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'blinks'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb8-5">template.save(temp_dir.name <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'/template_ica.fif'</span>)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>Writing ICA solution to /tmp/tmp08xo0rwc/template_ica.fif...</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="4">
<table class="table mne-repr-table caption-top table-sm table-striped small">
<colgroup>
<col style="width: 50%">
<col style="width: 50%">
</colgroup>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">Method</th>
<td>fastica</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Fit parameters</th>
<td>algorithm=parallel<br>
fun=logcosh<br>
fun_args=None<br>
max_iter=1000<br>
</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">Fit</th>
<td>56 iterations on epochs (11020 samples)</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">ICA components</th>
<td>32</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">Available PCA components</th>
<td>59</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Channel types</th>
<td>eeg</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">ICA components marked for exclusion</th>
<td>—</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Now we can iterate through all entries in the <code>.labels_</code> attribute and use <code>corrmap</code> to find components that are <strong>similar</strong> to the respective template. The first input for <code>corrmap</code> is the list of ICAs being processed. The second input is a tuple with the index of the ICA instance in the list and the component of that ICA being used as <strong>template</strong>. Similar components that are detected are stored in the <code>.labels_</code> attribute of the respective ICA instance.</p>
<div id="bcd08686" class="cell" data-execution_count="5">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> mne.preprocessing <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> read_ica, corrmap</span>
<span id="cb10-2">template <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> read_ica(temp_dir.name <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'/template_ica.fif'</span>)</span>
<span id="cb10-3"></span>
<span id="cb10-4"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> key, value <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> template.labels_.items():</span>
<span id="cb10-5">    corrmap([template, ica], (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, value[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]), label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>key, threshold<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.85</span>, plot<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>Reading /tmp/tmp08xo0rwc/template_ica.fif ...
    Read a total of 1 projection items:
        Average EEG reference (1 x 60) active
Now restoring ICA solution ...
Ready.
Median correlation with constructed map: 1.000
At least 1 IC detected for each subject.</code></pre>
</div>
</div>
<p>Of course, this example is completely circular because we applied <code>corrmap</code> to the same data we used for selecting the template in the first place. However, once selected, the same template can be applied to <strong>multiple recorings</strong> and even <strong>across experiments</strong>, given that the electrode layout is the same. After all artifact components have been identified, we can exclude them when <strong>applying</strong> the ICA to the sensor data.</p>
<div id="0b2a7496" class="cell" data-execution_count="6">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1">bad_components <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [value[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> value <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> ica.labels_.values()]</span>
<span id="cb12-2">epochs.load_data() <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># make sure data is loaded</span></span>
<span id="cb12-3">epochs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ica.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">apply</span>(epochs, exclude<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>bad_components)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>Applying ICA to Epochs instance
    Applying projection operator with 1 vector (pre-whitener application)
    Transforming to ICA space (32 components)
    Zeroing out 1 ICA component
    Projecting back using 59 PCA components</code></pre>
</div>
</div>
</section>
<section id="when-data-must-be-rejected" class="level1">
<h1>When data must be rejected</h1>
<p>Even with all the preprocessing steps discussed in this guide, some data can’t be saved. Sometimes, a channels <strong>loses contact</strong> with the scalp or a segment is noise-ridden, for example due to <strong>excessive movement</strong>. In those cases, we have to remove that data so it won’t <strong>contaminate</strong> the average response. Traditionally, EEG data is <strong>manually inspected</strong>, bad channels are interpolated and bad segments are annotated for rejection by hand. This is suboptimal for several reasons: first, scanning tens of hours of EEG recordings is tedious, <strong>time consuming</strong> and unfeasible for very large data sets. What’s more, the manual approach <strong>reduces reproducibility</strong> because the criteria for what counts as a bad channel or segment are subjective. Finally, it is often not necessary to interpolate a channel for the entire recording if it is bad for <strong>only a fraction</strong>.</p>
</section>
<section id="introducing-autoreject" class="level1">
<h1>Introducing autoreject</h1>
<p>All of these problems are addressed by the <code>autoreject</code> algorithm <sup>7</sup>, which is a procedure to identify and either <strong>repair or reject</strong> bad data segments. For each channel p, it estimates a peak-to-peak <strong>threshold</strong> τ. Each channel marks epochs as bad that exceeds their respective threshold. A trial is rejected if a <strong>fraction κ</strong> of all channels marks it as bad. If less than κ channels are bad, up to <strong>ρ are interpolated</strong> to repair the epoch. All parameters, τ κ and ρ are <strong>estimated from the data</strong> using cross-validation. Thus the optimal set of parameters are those that <strong>minimize the difference</strong> between testing and training data. In this sense, <code>autoreject</code> acts similar to a <strong>human observer</strong> identifying outliers in the data. After installing the module with <code>pip install autoreject</code>, we can simply apply it to the epoched data. I also plot the <strong>rejection log</strong> to visualize the effect of <code>autoreject</code> on the data.</p>
<div id="a9608083" class="cell" data-execution_count="7">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> autoreject <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> AutoReject</span>
<span id="cb14-2"></span>
<span id="cb14-3">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots()</span>
<span id="cb14-4">ar <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> AutoReject(verbose<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb14-5">epochs, log <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ar.fit_transform(epochs, return_log<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb14-6">log.plot(orientation<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"horizontal"</span>, ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ax)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>Dropped 2 epochs: 32, 40</code></pre>
</div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-8-output-2.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3" title="Matrix displaying the results of autoreject. Each column is one trial, and blue squares indicate interpolated sensors. Red columns were deemed “bad” and marked for rejection."><img src="https://olebialas.github.io/posts/2024-02-23-eeg_preprocessing_2/index_files/figure-html/cell-8-output-2.png" width="662" height="353" alt="Matrix displaying the results of autoreject. Each column is one trial, and blue squares indicate interpolated sensors. Red columns were deemed “bad” and marked for rejection." class="figure-img"></a></p>
<figcaption>Matrix displaying the results of <code>autoreject</code>. Each column is one trial, and blue squares indicate interpolated sensors. Red columns were deemed “bad” and marked for rejection.</figcaption>
</figure>
</div>
</div>
</div>
<p>In the plot below, blue marks channels that have been <strong>interpolated</strong> within a given epoch. Red marks channels that have been deemed bad but not interpolated because the number of bad channels <strong>exceeded ρ</strong>. The red column at epoch 40 indicates that this epoch has been <strong>rejected</strong> because the number of bad channels <strong>exceeded κ</strong>.</p>
</section>
<section id="conclusion" class="level1">
<h1>Conclusion</h1>
<p>The repertoire of preprocessing methods outlined in this and the previous post is sufficient to clean data for most EEG projects. Importantly, all steps can be assembled into a <strong>fully automated</strong> pipeline. In the next and final post in this series, I will share a such a pipeline and demonstrate a method for estimating the <strong>effectiveness</strong> of each step.</p>
</section>
<section id="footnotes" class="level1">
<h1>Footnotes</h1>


</section>


<a onclick="window.scrollTo(0, 0); return false;" id="quarto-back-to-top"><i class="bi bi-arrow-up"></i> Back to top</a><div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>This is referred to as the corneo-retinal dipole. A explanation of the underlying physiology can be found in: <em>Arden, G. B., &amp; Constable, P. A. (2006). The electro-oculogram. Progress in retinal and eye research, 25(2), 207-248.</em>↩︎</p></li>
<li id="fn2"><p>A detailed investigation of eye-artifacts and their detection via ICA can be found in: <em>Plöchl, M., Ossandón, J. P., &amp; König, P. (2012). Combining EEG and eye tracking: identification, characterization, and correction of eye movement artifacts in electroencephalographic data. Frontiers in human neuroscience, 6, 278.</em>↩︎</p></li>
<li id="fn3"><p>An in-depth explanation of ICA is beyond the scope of this post but can be found in: <em>Makeig, S., Bell, A., Jung, T. P., &amp; Sejnowski, T. J. (1995). Independent component analysis of electroencephalographic data. Advances in neural information processing systems, 8.</em>↩︎</p></li>
<li id="fn4"><p>A highpass between 1 and 2 Hz before ICA is optimal, see <em>Winkler, I., Debener, S., Müller, K. R., &amp; Tangermann, M. (2015, August). On the influence of high-pass filtering on ICA-based artifact reduction in EEG-ERP. In 2015 37th Annual International Conference of the IEEE Engineering in Medicine and Biology Society (EMBC) (pp.&nbsp;4101-4105). IEEE.</em>↩︎</p></li>
<li id="fn5"><p>The absolute sign of the component is meaningless and may change when ICA is performed repeatedly.↩︎</p></li>
<li id="fn6"><p>A detailed description of the corrmap algorithm can be found in <em>Viola, F. C., Thorne, J., Edmonds, B., Schneider, T., Eichele, T., &amp; Debener, S. (2009). Semi-automatic identification of independent components representing EEG artifact. Clinical Neurophysiology, 120(5), 868-877.</em>↩︎</p></li>
<li id="fn7"><p>A detailed description of the autoreject algorithm can be found in <em>Jas, M., Engemann, D. A., Bekhti, Y., Raimondo, F., &amp; Gramfort, A. (2017). Autoreject: Automated artifact rejection for MEG and EEG data. NeuroImage, 159, 417-429.</em>↩︎</p></li>
</ol>
</section></div> ]]></description>
  <guid>https://olebialas.github.io/posts/2024-02-23-eeg_preprocessing_2/</guid>
  <pubDate>Thu, 22 Feb 2024 23:00:00 GMT</pubDate>
  <media:content url="https://olebialas.github.io/posts/2024-02-23-eeg_preprocessing_2/featured.png" medium="image" type="image/png" height="77" width="144"/>
</item>
<item>
  <title>EEG preprocessing I: detrending, denoising and referencing</title>
  <dc:creator>Ole Bialas</dc:creator>
  <link>https://olebialas.github.io/posts/2024-01-16-eeg_preprocessing_1/</link>
  <description><![CDATA[ 






<p><strong>E</strong>lectro<strong>e</strong>ncephalo<strong>g</strong>raphy (EEG) measures brain activity via electrodes on the scalp. Unfortunately, those electrodes also picks up other things like <strong>muscle activity</strong> and electromagnetic <strong>interference</strong> that are <strong>orders of magnitude</strong> larger than neural responses. There is a vast literature and <strong>no consensus</strong> on how to deal with this problem.</p>
<section id="to-preprocess-or-not-to-preprocess" class="level1">
<h1>To preprocess or not to preprocess?</h1>
<p>A recent paper which got some attention argued that sophisticated preprocessing pipelines are <strong>altering data for the worse</strong> and that <em>“EEG is better left alone”</em> <sup>1</sup>. While I generally agree that preprocessing should be kept <strong>as minimal as possible</strong>, I think there are some issues with this generalized statement.</p>
<p>The paper considers a preprocessing method to be effective if it increases the number of <strong>channels significantly differing</strong> between conditions. However, without a known <strong>ground truth</strong>, we can’t distinguish true effects from spurious findings that may result from <strong>distorting</strong> the data. Thus, increased significance does not necessarily prove a method’s superiority!</p>
<p>Also, the paper does not consider data of <strong>varying quality</strong>. Even if certain methods won’t improve recordings of high quality, they may still be beneficial if the data is more noisy, for example if it was recorded in a hospital <strong>without sufficient electric shielding</strong>.</p>
<p>For these reasons, I decided to split this guide into two parts. Part I describes a <strong>minimal set</strong> of preprocessing steps that are necessary for most EEG analyses. The procedures I suggest are <strong>robust</strong> to noise and minimize the <strong>risk of distorting</strong> the data. Part II will introduce additional procedures that may help with more <strong>noisy data</strong>.</p>
</section>
<section id="prerequisites" class="level1">
<h1>Prerequisites</h1>
<p>To follow along with the examles, you’ll have to install several packages. I recommend creating a new environment and using pip to install:</p>
<pre><code>pip install mne meegkit pyprep</code></pre>
<p>We’ll use <strong>sample data</strong> provided by MNE-Python which will be downloaded automatically when you call the <code>data_path</code> function for the first time. Then, we load the raw data, find <strong>events</strong> in the data (we’ll need those later) and remove everything but the EEG channels <sup>2</sup>. Finally, we <strong>downsample</strong> the data so processing will be quicker.</p>
<div id="6b628f92" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> mne.io <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> read_raw_fif</span>
<span id="cb2-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> mne.datasets.sample <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> data_path</span>
<span id="cb2-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> mne <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> find_events</span>
<span id="cb2-4"></span>
<span id="cb2-5">raw <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> read_raw_fif(data_path() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"MEG/sample/sample_audvis_raw.fif"</span>)</span>
<span id="cb2-6">events <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> find_events(raw)</span>
<span id="cb2-7">raw.pick(picks<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"eeg"</span>)</span>
<span id="cb2-8">raw, events <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> raw.resample(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">150</span>, events<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>events)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>Opening raw data file /home/olebi/mne_data/MNE-sample-data/MEG/sample/sample_audvis_raw.fif...
    Read a total of 3 projection items:
        PCA-v1 (1 x 102)  idle
        PCA-v2 (1 x 102)  idle
        PCA-v3 (1 x 102)  idle
    Range : 25800 ... 192599 =     42.956 ...   320.670 secs
Ready.
Finding events on: STI 014
320 events found on stim channel STI 014
Event IDs: [ 1  2  3  4  5 32]</code></pre>
</div>
</div>
</section>
<section id="channel-drifts-and-offsets" class="level1">
<h1>Channel drifts and offsets</h1>
<p>Channels differ in their <strong>conductivity</strong> with the scalp and this conductivity may also change across time, for example if the subject is sweating. This results in different and <strong>drifting baselines</strong> that can overshadow neural activity. Let’s look at two exemplar channels:</p>
<div id="3c470511" class="cell" data-execution_count="2">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> matplotlib <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb4-2"></span>
<span id="cb4-3">plt.plot(raw.times, raw.get_data()[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>], :].T <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e6</span>, linewidth<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>)</span>
<span id="cb4-4">plt.xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Time [s]"</span>)</span>
<span id="cb4-5">plt.ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Voltage [muV]"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-3-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1" title="Two EEG channels before detrending. Note how the time series are similar but differ in their offset."><img src="https://olebialas.github.io/posts/2024-01-16-eeg_preprocessing_1/index_files/figure-html/cell-3-output-1.png" width="604" height="429" alt="Two EEG channels before detrending. Note how the time series are similar but differ in their offset." class="figure-img"></a></p>
<figcaption>Two EEG channels before detrending. Note how the time series are similar but differ in their offset.</figcaption>
</figure>
</div>
</div>
</div>
<p>A common way to deal with fluctuating baselines is to apply a <strong>high pass filter</strong>, suppressing all fluctuations at frequencies below some threshold (often 0.5 or 1 Hz). While this effectively removes channel offsets and drifts, it may also <strong>smear</strong> the signal or even introduce <strong>spurious</strong> features <sup>3</sup>.</p>
<p>An alternative is to detrend the data by fitting a polynomial and subtracting the fit. Here, I use an algorithm for <strong>robust detrending</strong> that ignores outliers <sup>4</sup>. I apply detrending twice - first using a line and then a <strong>higher-order</strong> polynomial to remove faster baseline fluctuations.</p>
<div id="36111440" class="cell" data-execution_count="3">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> meegkit.detrend <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> detrend</span>
<span id="cb5-2"></span>
<span id="cb5-3">X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> raw.get_data().T  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># transpose so the data is organized time-by-channels</span></span>
<span id="cb5-4">X, _, _ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> detrend(X, order<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb5-5">X, _, _ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> detrend(X, order<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>)</span>
<span id="cb5-6">raw._data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> X.T  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># overwrite raw data</span></span>
<span id="cb5-7">plt.plot(raw.times, X[:, [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>]], linewidth<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>)</span>
<span id="cb5-8">plt.xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Time [s]"</span>)</span>
<span id="cb5-9">plt.ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Voltage [muV]"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-4-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2" title="The same two EEG channels after detrending. Note how removing the offset makes comparing the signals much easier."><img src="https://olebialas.github.io/posts/2024-01-16-eeg_preprocessing_1/index_files/figure-html/cell-4-output-1.png" width="625" height="429" alt="The same two EEG channels after detrending. Note how removing the offset makes comparing the signals much easier." class="figure-img"></a></p>
<figcaption>The same two EEG channels after detrending. Note how removing the offset makes comparing the signals much easier.</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="removing-power-line-noise" class="level1">
<h1>Removing power line noise</h1>
<p>Another ubiquitous problem is the presence of power line noise. This takes the form of an oscillation at the frequency of the <strong>alternating current</strong> signal which is <strong>60 Hz</strong> in the US and <strong>50 Hz</strong> in the rest of the world. To see this, we can plot the power spectral density (PSD), which shows the signals <strong>power content</strong> across frequencies.</p>
<div id="e03a3201" class="cell" data-execution_count="4">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots()</span>
<span id="cb6-2">psd <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> raw.compute_psd()</span>
<span id="cb6-3">psd.plot(axes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ax, average<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>Effective window size : 13.653 (s)
Plotting power spectral density (dB=True).</code></pre>
</div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-5-output-2.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3" title="Power spectral density (PSD) of the EEG recording before filtering. Note the peak at 60 Hz marked by the dashed line."><img src="https://olebialas.github.io/posts/2024-01-16-eeg_preprocessing_1/index_files/figure-html/cell-5-output-2.png" width="600" height="449" alt="Power spectral density (PSD) of the EEG recording before filtering. Note the peak at 60 Hz marked by the dashed line." class="figure-img"></a></p>
<figcaption>Power spectral density (PSD) of the EEG recording before filtering. Note the peak at 60 Hz marked by the dashed line.</figcaption>
</figure>
</div>
</div>
</div>
<p>Even though this recording is very clean, you can make out a little spike in the PSD at 60 Hz. The most common solution to power line noise is to apply a <strong>low pass or notch filter</strong> that removes all activity within the contaminated frequency band. However, to sharply separate noise and signal frequencies, the filter must have a steep transfer function which results in a long impulse response that introduces <strong>ringing artifacts</strong> into the signal.</p>
<p>Alternatively, one may use a <strong>spatial filter</strong> but this only works if noise and neural signal are <strong>linearly separable</strong>. Here, I use an algorithm that <strong>combines</strong> the advantages of both approaches to remove power line noise while minimizing distortions and loss of data <sup>5</sup>.</p>
<div id="a5dae1d2" class="cell" data-execution_count="5">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> meegkit.dss <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> dss_line</span>
<span id="cb8-2">X, noise <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dss_line(X, fline<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">60</span>, sfreq<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>raw.info[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'sfreq'</span>], nremove<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span>
<span id="cb8-3">raw._data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> X.T</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>Power of components removed by DSS: 0.00</code></pre>
</div>
</div>
<p>To verify that the algorithm worked as expected we visualize the power content of the removed noise. The PSD should be <strong>mostly flat</strong>, except for a spike at the power line frequency.</p>
<div id="8a7c07f9" class="cell" data-execution_count="6">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> mne.io <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> RawArray</span>
<span id="cb10-2"></span>
<span id="cb10-3">noise <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> RawArray(noise.T, raw.info)</span>
<span id="cb10-4">psd_noise <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> noise.compute_psd()</span>
<span id="cb10-5">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots()</span>
<span id="cb10-6">psd_noise.plot(axes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ax, average<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>Creating RawArray with float64 data, n_channels=60, n_times=41657
    Range : 0 ... 41656 =      0.000 ...   277.707 secs
Ready.
Effective window size : 13.653 (s)
Plotting power spectral density (dB=True).</code></pre>
</div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-7-output-2.png" class="lightbox" data-gallery="quarto-lightbox-gallery-4" title="Power spectral density (PSD) of the noise separated by the spatial filter. Note the peak at 60 Hz is more prominent compared to the PSD of the full signal."><img src="https://olebialas.github.io/posts/2024-01-16-eeg_preprocessing_1/index_files/figure-html/cell-7-output-2.png" width="600" height="449" alt="Power spectral density (PSD) of the noise separated by the spatial filter. Note the peak at 60 Hz is more prominent compared to the PSD of the full signal." class="figure-img"></a></p>
<figcaption>Power spectral density (PSD) of the noise separated by the spatial filter. Note the peak at 60 Hz is more prominent compared to the PSD of the full signal.</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="re-referencing-to-a-robust-average" class="level1">
<h1>Re-referencing to a robust average</h1>
<p>Voltage is the difference in electric potential between two points. Thus, the voltage measured at each EEG channel is relative to some <strong>common reference</strong> point. Because manufacturers use different recording references it is usually a good idea to re-reference the signals.</p>
<p>This is done by simply <strong>subtracting</strong> a channel or combination of channels. While this changes the absolute magnitudes, it does not alter the <strong>relations</strong> between channels. Imagine the peaks and valleys in voltage as a landscape and re-referencing as <strong>changing your standpoint</strong>. Depending on where you stand, any <strong>single point</strong> may be above or below you, but the landscape stays the same!</p>
<p>A common reference choice is to use the <strong>average</strong> of all channels. However, single “bad” channels, containing large artifacts may skew the average and <strong>leak</strong> those artifacts into all other channels. To prevent this from happening, we can <strong>identify and interpolate</strong> those bad channels before computing the average.</p>
<p>I use the random sample consensus (RANSAC) method <sup>6</sup> to identify bad channels. RANSAC <strong>predicts EEG</strong> channels from their neighbors and marks them as bad if their correlation with that prediction fails to meet some <strong>threshold</strong>.</p>
<div id="76093b15" class="cell" data-execution_count="7">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> pyprep.ransac <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> find_bad_by_ransac</span>
<span id="cb12-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb12-3"></span>
<span id="cb12-4">bads, _ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> find_bad_by_ransac(</span>
<span id="cb12-5">     data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> raw.get_data(),</span>
<span id="cb12-6">     sample_rate <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> raw.info[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'sfreq'</span>],</span>
<span id="cb12-7">     complete_chn_labs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.asarray(raw.info[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ch_names'</span>]),</span>
<span id="cb12-8">     chn_pos <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.stack([ch[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'loc'</span>][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> ch <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> raw.info[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'chs'</span>]]),</span>
<span id="cb12-9">     exclude <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [],</span>
<span id="cb12-10">     corr_thresh <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span></span>
<span id="cb12-11">     )</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>Executing RANSAC
This may take a while, so be patient...</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"f946be2a914a45bd980337c1a921ac21","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
RANSAC done!</code></pre>
</div>
</div>
<p>Because we don’t actually want to remove anything yet (data rejection will be addressed in the next post), we <strong>copy the data</strong> before interpolating the bad channels. Then, we compute the average reference on this cleaned copy and apply it to the original data as a <strong>projection</strong>.</p>
<div id="63f6ba82" class="cell" data-execution_count="8">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1">raw_clean <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> raw.copy()</span>
<span id="cb15-2">raw_clean.info[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'bads'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> bads</span>
<span id="cb15-3">raw_clean.interpolate_bads()</span>
<span id="cb15-4">raw_clean.set_eeg_reference(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'average'</span>, projection<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#compute the reference</span></span>
<span id="cb15-5">raw.add_proj(raw_clean.info[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'projs'</span>][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])</span>
<span id="cb15-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">del</span> raw_clean  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># delete the copy</span></span>
<span id="cb15-7">raw.apply_proj()  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># apply the reference</span></span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>Setting channel interpolation method to {'eeg': 'spline'}.
Interpolating bad channels.
    Automatic origin fit: head of radius 91.2 mm
Computing interpolation matrix from 51 sensor positions
Interpolating 9 sensors
EEG channel type selected for re-referencing
Adding average EEG reference projection.
1 projection items deactivated
Average reference projection was added, but has not been applied yet. Use the apply_proj method to apply it.
1 projection items deactivated
Created an SSP operator (subspace dimension = 1)
1 projection items activated
SSP projectors applied...</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="8">
<script type="text/javascript">
    // must be `var` (not `const`) because this can get embedded multiple times on a page
var toggleVisibility = (className) => {

    const elements = document.querySelectorAll(`.${className}`);

    elements.forEach(element => {
        if (element.classList.contains("mne-repr-section-header")) {
            return  // Don't collapse the section header row
        }
        element.classList.toggle("mne-repr-collapsed");
    });

    // trigger caret to rotate
    var sel = `.mne-repr-section-header.${className} > th.mne-repr-section-toggle > button`;
    const button = document.querySelector(sel);
    button.classList.toggle("collapsed");

    // adjust tooltip
    sel = `tr.mne-repr-section-header.${className}`;
    const secHeadRow = document.querySelector(sel);
    secHeadRow.classList.toggle("collapsed");
    secHeadRow.title = secHeadRow.title === "Hide section" ? "Show section" : "Hide section";
}
</script>

<style type="text/css">
    /*
Styles in this section apply both to the sphinx-built website docs and to notebooks
rendered in an IDE or in Jupyter. In our web docs, styles here are complemented by
doc/_static/styles.css and other CSS files (e.g. from the sphinx theme, sphinx-gallery,
or bootstrap). In IDEs/Jupyter, those style files are unavailable, so only the rules in
this file apply (plus whatever default styling the IDE applies).
*/
.mne-repr-table {
    display: inline;  /* prevent using full container width */
}
.mne-repr-table tr.mne-repr-section-header > th {
    padding-top: 1rem;
    text-align: left;
    vertical-align: middle;
}
.mne-repr-section-toggle > button {
    all: unset;
    display: block;
    height: 1rem;
    width: 1rem;
}
.mne-repr-section-toggle > button > svg {
    height: 60%;
}

/* transition (rotation) effects on the collapser button */
.mne-repr-section-toggle > button.collapsed > svg {
    transition: 0.1s ease-out;
    transform: rotate(-90deg);
}
.mne-repr-section-toggle > button:not(.collapsed) > svg {
    transition: 0.1s ease-out;
    transform: rotate(0deg);
}

/* hide collapsed table rows */
.mne-repr-collapsed {
    display: none;
}


@layer {
    /*
    Selectors in a `@layer` will always be lower-precedence than selectors outside the
    layer. So even though e.g. `div.output_html` is present in the sphinx-rendered
    website docs, the styles here won't take effect there as long as some other rule
    somewhere in the page's CSS targets the same element.

    In IDEs or Jupyter notebooks, though, the CSS files from the sphinx theme,
    sphinx-gallery, and bootstrap are unavailable, so these styles will apply.

    Notes:

    - the selector `.accordion-body` is for MNE Reports
    - the selector `.output_html` is for VSCode's notebook interface
    - the selector `.jp-RenderedHTML` is for Jupyter notebook
    - variables starting with `--theme-` are VSCode-specific.
    - variables starting with `--jp-` are Jupyter styles, *some of which* are also
      available in VSCode. Here we try the `--theme-` variable first, then fall back to
      the `--jp-` ones.
    */
    .mne-repr-table {
        --mne-toggle-color: var(--theme-foreground, var(--jp-ui-font-color1));
        --mne-button-bg-color: var(--theme-button-background, var(--jp-info-color0, var(--jp-content-link-color)));
        --mne-button-fg-color: var(--theme-button-foreground, var(--jp-ui-inverse-font-color0, var(--jp-editor-background)));
        --mne-button-hover-bg-color: var(--theme-button-hover-background, var(--jp-info-color1));
        --mne-button-radius: var(--jp-border-radius, 0.25rem);
    }
    /* chevron position/alignment; in VSCode it looks ok without adjusting */
    .accordion-body .mne-repr-section-toggle > button,
    .jp-RenderedHTML .mne-repr-section-toggle > button {
        padding: 0 0 45% 25% !important;
    }
    /* chevron color; MNE Report doesn't have light/dark mode */
    div.output_html .mne-repr-section-toggle > button > svg > path,
    .jp-RenderedHTML .mne-repr-section-toggle > button > svg > path {
        fill: var(--mne-toggle-color);
    }
    .accordion-body .mne-ch-names-btn,
    div.output_html .mne-ch-names-btn,
    .jp-RenderedHTML .mne-ch-names-btn {
        -webkit-border-radius: var(--mne-button-radius);
        -moz-border-radius: var(--mne-button-radius);
        border-radius: var(--mne-button-radius);
        border: none;
        background-image: none;
        background-color: var(--mne-button-bg-color);
        color: var(--mne-button-fg-color);
        font-size: inherit;
        min-width: 1.5rem;
        padding: 0.25rem;
        text-align: center;
        text-decoration: none;
    }
    .accordion-body .mne-ch-names-btn:hover,
    div.output_html .mne.ch-names-btn:hover,
    .jp-RenderedHTML .mne-ch-names-btn:hover {
        background-color: var(--mne-button-hover-bg-color);
        text-decoration: underline;
    }
    .accordion-body .mne-ch-names-btn:focus-visible,
    div.output_html .mne-ch-names-btn:focus-visible,
    .jp-RenderedHTML .mne-ch-names-btn:focus-visible {
        outline: 0.1875rem solid var(--mne-button-bg-color) !important;
        outline-offset: 0.1875rem !important;
    }
}
</style>




<table class="table mne-repr-table caption-top table-sm table-striped small">
<colgroup>
<col style="width: 33%">
<col style="width: 33%">
<col style="width: 33%">
</colgroup>
<tbody>
<tr class="mne-repr-section-header general-c82ac63b-1d68-4561-8f35-ad716f25c083 odd" title="Hide section" onclick="toggleVisibility('general-c82ac63b-1d68-4561-8f35-ad716f25c083')">
<th class="mne-repr-section-toggle" data-quarto-table-cell-role="th"><button>
<svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 512 512">
<!--!Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.--><path d="M233.4 406.6c12.5 12.5 32.8 12.5 45.3 0l192-192c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L256 338.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l192 192z"></path>
</svg>
</button></th>
<th colspan="2" data-quarto-table-cell-role="th"><strong>General</strong></th>
</tr>
<tr class="repr-element general-c82ac63b-1d68-4561-8f35-ad716f25c083 even">
<td class="mne-repr-section-toggle"></td>
<td>Filename(s)</td>
<td>sample_audvis_raw.fif</td>
</tr>
<tr class="repr-element general-c82ac63b-1d68-4561-8f35-ad716f25c083 odd">
<td class="mne-repr-section-toggle"></td>
<td>MNE object type</td>
<td>Raw</td>
</tr>
<tr class="repr-element general-c82ac63b-1d68-4561-8f35-ad716f25c083 even">
<td class="mne-repr-section-toggle"></td>
<td>Measurement date</td>
<td>2002-12-03 at 19:01:10 UTC</td>
</tr>
<tr class="repr-element general-c82ac63b-1d68-4561-8f35-ad716f25c083 odd">
<td class="mne-repr-section-toggle"></td>
<td>Participant</td>
<td>Unknown</td>
</tr>
<tr class="repr-element general-c82ac63b-1d68-4561-8f35-ad716f25c083 even">
<td class="mne-repr-section-toggle"></td>
<td>Experimenter</td>
<td>MEG</td>
</tr>
<tr class="mne-repr-section-header acquisition-15116e97-e841-45c8-b98d-0452de39d627 odd" title="Hide section" onclick="toggleVisibility('acquisition-15116e97-e841-45c8-b98d-0452de39d627')">
<th class="mne-repr-section-toggle" data-quarto-table-cell-role="th"><button>
<svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 512 512">
<!--!Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.--><path d="M233.4 406.6c12.5 12.5 32.8 12.5 45.3 0l192-192c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L256 338.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l192 192z"></path>
</svg>
</button></th>
<th colspan="2" data-quarto-table-cell-role="th"><strong>Acquisition</strong></th>
</tr>
<tr class="repr-element acquisition-15116e97-e841-45c8-b98d-0452de39d627 even">
<td class="mne-repr-section-toggle"></td>
<td>Duration</td>
<td>00:04:38 (HH:MM:SS)</td>
</tr>
<tr class="repr-element acquisition-15116e97-e841-45c8-b98d-0452de39d627 odd">
<td class="mne-repr-section-toggle"></td>
<td>Sampling frequency</td>
<td>150.00 Hz</td>
</tr>
<tr class="repr-element acquisition-15116e97-e841-45c8-b98d-0452de39d627 even">
<td class="mne-repr-section-toggle"></td>
<td>Time points</td>
<td>41,657</td>
</tr>
<tr class="mne-repr-section-header channels-9eee3439-0775-4fe8-9f91-d02f08fd238f odd" title="Hide section" onclick="toggleVisibility('channels-9eee3439-0775-4fe8-9f91-d02f08fd238f')">
<th class="mne-repr-section-toggle" data-quarto-table-cell-role="th"><button>
<svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 512 512">
<!--!Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.--><path d="M233.4 406.6c12.5 12.5 32.8 12.5 45.3 0l192-192c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L256 338.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l192 192z"></path>
</svg>
</button></th>
<th colspan="2" data-quarto-table-cell-role="th"><strong>Channels</strong></th>
</tr>
<tr class="repr-element channels-9eee3439-0775-4fe8-9f91-d02f08fd238f even">
<td class="mne-repr-section-toggle"></td>
<td>EEG</td>
<td><button class="mne-ch-names-btn sd-sphinx-override sd-btn sd-btn-info sd-text-wrap sd-shadow-sm" onclick="alert('Good EEG:\n\nEEG&nbsp;001, EEG&nbsp;002, EEG&nbsp;003, EEG&nbsp;004, EEG&nbsp;005, EEG&nbsp;006, EEG&nbsp;007, EEG&nbsp;008, EEG&nbsp;009, EEG&nbsp;010, EEG&nbsp;011, EEG&nbsp;012, EEG&nbsp;013, EEG&nbsp;014, EEG&nbsp;015, EEG&nbsp;016, EEG&nbsp;017, EEG&nbsp;018, EEG&nbsp;019, EEG&nbsp;020, EEG&nbsp;021, EEG&nbsp;022, EEG&nbsp;023, EEG&nbsp;024, EEG&nbsp;025, EEG&nbsp;026, EEG&nbsp;027, EEG&nbsp;028, EEG&nbsp;029, EEG&nbsp;030, EEG&nbsp;031, EEG&nbsp;032, EEG&nbsp;033, EEG&nbsp;034, EEG&nbsp;035, EEG&nbsp;036, EEG&nbsp;037, EEG&nbsp;038, EEG&nbsp;039, EEG&nbsp;040, EEG&nbsp;041, EEG&nbsp;042, EEG&nbsp;043, EEG&nbsp;044, EEG&nbsp;045, EEG&nbsp;046, EEG&nbsp;047, EEG&nbsp;048, EEG&nbsp;049, EEG&nbsp;050, EEG&nbsp;051, EEG&nbsp;052, EEG&nbsp;054, EEG&nbsp;055, EEG&nbsp;056, EEG&nbsp;057, EEG&nbsp;058, EEG&nbsp;059, EEG&nbsp;060')" title="(Click to open in popup)

EEG&nbsp;001, EEG&nbsp;002, EEG&nbsp;003, EEG&nbsp;004, EEG&nbsp;005, EEG&nbsp;006, EEG&nbsp;007, EEG&nbsp;008, EEG&nbsp;009, EEG&nbsp;010, EEG&nbsp;011, EEG&nbsp;012, EEG&nbsp;013, EEG&nbsp;014, EEG&nbsp;015, EEG&nbsp;016, EEG&nbsp;017, EEG&nbsp;018, EEG&nbsp;019, EEG&nbsp;020, EEG&nbsp;021, EEG&nbsp;022, EEG&nbsp;023, EEG&nbsp;024, EEG&nbsp;025, EEG&nbsp;026, EEG&nbsp;027, EEG&nbsp;028, EEG&nbsp;029, EEG&nbsp;030, EEG&nbsp;031, EEG&nbsp;032, EEG&nbsp;033, EEG&nbsp;034, EEG&nbsp;035, EEG&nbsp;036, EEG&nbsp;037, EEG&nbsp;038, EEG&nbsp;039, EEG&nbsp;040, EEG&nbsp;041, EEG&nbsp;042, EEG&nbsp;043, EEG&nbsp;044, EEG&nbsp;045, EEG&nbsp;046, EEG&nbsp;047, EEG&nbsp;048, EEG&nbsp;049, EEG&nbsp;050, EEG&nbsp;051, EEG&nbsp;052, EEG&nbsp;054, EEG&nbsp;055, EEG&nbsp;056, EEG&nbsp;057, EEG&nbsp;058, EEG&nbsp;059, EEG&nbsp;060">
59
</button>
and
<button class="mne-ch-names-btn sd-sphinx-override sd-btn sd-btn-info sd-text-wrap sd-shadow-sm" onclick="alert('Bad EEG:\n\nEEG&nbsp;053')" title="(Click to open in popup)

EEG&nbsp;053">
1 bad
</button></td>
</tr>
<tr class="repr-element channels-9eee3439-0775-4fe8-9f91-d02f08fd238f odd">
<td class="mne-repr-section-toggle"></td>
<td>Head &amp; sensor digitization</td>
<td>146 points</td>
</tr>
<tr class="mne-repr-section-header filters-4ddbe2f5-8bc6-4296-a464-d24738c23d50 even" title="Hide section" onclick="toggleVisibility('filters-4ddbe2f5-8bc6-4296-a464-d24738c23d50')">
<th class="mne-repr-section-toggle" data-quarto-table-cell-role="th"><button>
<svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 512 512">
<!--!Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.--><path d="M233.4 406.6c12.5 12.5 32.8 12.5 45.3 0l192-192c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L256 338.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l192 192z"></path>
</svg>
</button></th>
<th colspan="2" data-quarto-table-cell-role="th"><strong>Filters</strong></th>
</tr>
<tr class="repr-element filters-4ddbe2f5-8bc6-4296-a464-d24738c23d50 odd">
<td class="mne-repr-section-toggle"></td>
<td>Highpass</td>
<td>0.10 Hz</td>
</tr>
<tr class="repr-element filters-4ddbe2f5-8bc6-4296-a464-d24738c23d50 even">
<td class="mne-repr-section-toggle"></td>
<td>Lowpass</td>
<td>75.00 Hz</td>
</tr>
<tr class="repr-element filters-4ddbe2f5-8bc6-4296-a464-d24738c23d50 odd">
<td class="mne-repr-section-toggle"></td>
<td>Projections</td>
<td>Average EEG reference (on)</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="epoching-the-data" class="level1">
<h1>Epoching the data</h1>
<p>Now we can epoch the data which means rearranging it into <strong>short segments</strong> centered around the presented stimuli. The segment duration is defined by the parameters <code>tmin</code> and <code>tmax</code> that are passed to MNE’s <code>Epochs</code> class. Per default, the signal before 0, the stimulus onset, is used as a <strong>baseline</strong> which means that it’s average is subtracted from the rest of the epoch.</p>
<p>I think this is <strong>not a good default</strong> choice because activity in the baseline period (e.g.&nbsp;due to anticipation of the stimulus) can be projected into the rest of the epoch and <strong>create spurious features</strong> that look like actual brain responses. In most cases, baselining is <strong>not necessary</strong> if the data were detrended or high pass filtered.</p>
<p>After epoching,we can average all segments to obtain the <strong>event related potential</strong> (ERP), which is the part of the brain response, evoked by the stimuli (since spontaneous activity will average out). We can visualize the ERP to make sure that our preprocessing was effective and we have <strong>clean data</strong>.</p>
<div id="961ce55a" class="cell" data-execution_count="9">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> mne.epochs <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Epochs</span>
<span id="cb17-2"></span>
<span id="cb17-3">event_id <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"auditory/left"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"auditory/right"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>}</span>
<span id="cb17-4">epochs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Epochs(raw, events, event_id, tmin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, tmax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>, baseline<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>)</span>
<span id="cb17-5">epochs.average().plot()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>Not setting metadata
145 matching events found
No baseline correction applied
Created an SSP operator (subspace dimension = 1)
1 projection items activated</code></pre>
</div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="index_files/figure-html/cell-10-output-2.png" class="lightbox" data-gallery="quarto-lightbox-gallery-5" title="Event related potential (ERP) obtained by averaging the responses to all auditory stimuli. Each line represents one EEG channel."><img src="https://olebialas.github.io/posts/2024-01-16-eeg_preprocessing_1/index_files/figure-html/cell-10-output-2.png" width="626" height="299" alt="Event related potential (ERP) obtained by averaging the responses to all auditory stimuli. Each line represents one EEG channel." class="figure-img"></a></p>
<figcaption>Event related potential (ERP) obtained by averaging the responses to all auditory stimuli. Each line represents one EEG channel.</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="what-next" class="level1">
<h1>What next?</h1>
<p>We removed offsets, drifts and power-line noise, re-referenced the data to a robust average and epoched them. Now the epochs may be <strong>ready for statistical analysis</strong> or it they may require more cleaning. In the next post on preprocessing I will explain how to <strong>remove eye blink artifacts</strong> and identify and <strong>remove data segments</strong> that are beyond saving.</p>
</section>
<section id="footnotes" class="level1">
<h1>Footnotes</h1>


</section>


<a onclick="window.scrollTo(0, 0); return false;" id="quarto-back-to-top"><i class="bi bi-arrow-up"></i> Back to top</a><div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Delorme, A. (2023). EEG is better left alone. Scientific reports, 13(1), 2372.↩︎</p></li>
<li id="fn2"><p>The preprocessing steps described here apply to MEG as well - I just omitted it for the sake of simplicity.↩︎</p></li>
<li id="fn3"><p>For a detailed investigation of this issue see de Cheveigné, A., &amp; Nelken, I. (2019). Filters: when, why, and how (not) to use them. Neuron, 102(2), 280-293.↩︎</p></li>
<li id="fn4"><p>The detrending algorithm is described in: de Cheveigné, A., &amp; Arzounian, D. (2018). Robust detrending, rereferencing, outlier detection, and inpainting for multichannel data. NeuroImage, 172, 903-912.↩︎</p></li>
<li id="fn5"><p>The denoising algorithm is described in: de Cheveigné, A. (2020). ZapLine: A simple and effective method to remove power line artifacts. NeuroImage, 207, 116356.↩︎</p></li>
<li id="fn6"><p>RANSAC is part of another EEG preprocessing pipeline described in: Bigdely-Shamlo, N., Mullen, T., Kothe, C., Su, K. M., &amp; Robbins, K. A. (2015). The PREP pipeline: standardized preprocessing for large-scale EEG analysis. Frontiers in neuroinformatics, 9, 16.↩︎</p></li>
</ol>
</section></div> ]]></description>
  <guid>https://olebialas.github.io/posts/2024-01-16-eeg_preprocessing_1/</guid>
  <pubDate>Mon, 15 Jan 2024 23:00:00 GMT</pubDate>
  <media:content url="https://olebialas.github.io/posts/2024-01-16-eeg_preprocessing_1/featured.png" medium="image" type="image/png" height="69" width="144"/>
</item>
</channel>
</rss>
